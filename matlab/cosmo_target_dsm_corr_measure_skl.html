    <!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>cosmo target dsm corr measure skl &#8212; CoSMo Multivariate Pattern Analysis toolbox 1.0rc1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=83e35b93" />
    <link rel="stylesheet" type="text/css" href="../_static/nature.css?v=279e0f84" />
    <script src="../_static/documentation_options.js?v=b2dc1058"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="next" title="cosmo tiedrank skl" href="cosmo_tiedrank_skl.html" />
    <link rel="prev" title="cosmo tail skl" href="cosmo_tail_skl.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="cosmo_tiedrank_skl.html" title="cosmo tiedrank skl"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="cosmo_tail_skl.html" title="cosmo tail skl"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">CoSMoMVPA</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../documentation.html" >Documentation</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../nmsm2019.html" >NMSM 2019, Noesselt’s lab 3rd Modelling Symposium, University of Magdeburg</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="../matindex_skl.html" accesskey="U">CoSMoMVPA functions - skeleton files</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">cosmo target dsm corr measure skl</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="cosmo-target-dsm-corr-measure-skl">
<span id="id1"></span><h1>cosmo target dsm corr measure skl<a class="headerlink" href="#cosmo-target-dsm-corr-measure-skl" title="Link to this heading">¶</a></h1>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span>ds_sa<span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">cosmo_target_dsm_corr_measure</span><span class="p">(</span>ds, varargin<span class="p">)</span>
<span class="w">    </span><span class="c">% measure correlation with target dissimilarity matrix</span>
<span class="w">    </span><span class="c">%</span>
<span class="w">    </span><span class="c">% ds_sa = cosmo_target_dsm_corr_measure(dataset, args)</span>
<span class="w">    </span><span class="c">%</span>
<span class="w">    </span><span class="c">% Inputs:</span>
<span class="w">    </span><span class="c">%   ds             dataset struct with field .samples PxQ for P samples and</span>
<span class="w">    </span><span class="c">%                  Q features</span>
<span class="w">    </span><span class="c">%   args           struct with fields:</span>
<span class="w">    </span><span class="c">%     .target_dsm  (optional) Either:</span>
<span class="w">    </span><span class="c">%                  - target dissimilarity matrix of size PxP. It should</span>
<span class="w">    </span><span class="c">%                    have zeros on the diagonal and be symmetric.</span>
<span class="w">    </span><span class="c">%                  - target dissimilarity vector of size Nx1, with</span>
<span class="w">    </span><span class="c">%                    N=P*(P-1)/2 the number of pairs of samples in ds.</span>
<span class="w">    </span><span class="c">%                  This option is mutually exclusive with the &#39;glm_dsm&#39;</span>
<span class="w">    </span><span class="c">%                  option</span>
<span class="w">    </span><span class="c">%     .metric      (optional) distance metric used in pdist to compute</span>
<span class="w">    </span><span class="c">%                  pair-wise distances between samples in ds. It accepts</span>
<span class="w">    </span><span class="c">%                  any metric supported by pdist (default: &#39;correlation&#39;)</span>
<span class="w">    </span><span class="c">%     .type        (optional) type of correlation between target_dsm and</span>
<span class="w">    </span><span class="c">%                  ds, one of &#39;Pearson&#39; (default), &#39;Spearman&#39;, or</span>
<span class="w">    </span><span class="c">%                  &#39;Kendall&#39;. If the &#39;regress_dsm&#39; option is used, then the</span>
<span class="w">    </span><span class="c">%                  specified correlation type is used for the partial</span>
<span class="w">    </span><span class="c">%                  correlaton computation, and a Pearson correlation</span>
<span class="w">    </span><span class="c">%                  is returned on the residuals (that is, the</span>
<span class="w">    </span><span class="c">%                  remaining dissimilarities after controlling for those</span>
<span class="w">    </span><span class="c">%                  in regress_dsm).</span>
<span class="w">    </span><span class="c">%     .regress_dsm (optional) target dissimilarity matrix or vector (as</span>
<span class="w">    </span><span class="c">%                  .target_dsm), or a cell with matrices or vectors, that</span>
<span class="w">    </span><span class="c">%                  should be regressed out. If this option is provided then</span>
<span class="w">    </span><span class="c">%                  the output is the partial (Pearson) correlation between</span>
<span class="w">    </span><span class="c">%                  the pairwise distances between samples in ds and</span>
<span class="w">    </span><span class="c">%                  target_dsm, after controlling for the effect of the</span>
<span class="w">    </span><span class="c">%                  matrix (or matrices) in regress_dsm. (Using this option</span>
<span class="w">    </span><span class="c">%                  yields similar behaviour as the Matlab function</span>
<span class="w">    </span><span class="c">%                  &#39;partial_corr&#39;).</span>
<span class="w">    </span><span class="c">%                  When using this option, the &#39;type&#39; option cannot be</span>
<span class="w">    </span><span class="c">%                  set to &#39;Kendall&#39;.</span>
<span class="w">    </span><span class="c">%     .glm_dsm     (optional) cell with model dissimilarity matrices or</span>
<span class="w">    </span><span class="c">%                  vectors (as .target_dsm) for using a general linear</span>
<span class="w">    </span><span class="c">%                  model to get regression coefficients for each element in</span>
<span class="w">    </span><span class="c">%                  .glm_dsm. Both the input data and the dissimilarity</span>
<span class="w">    </span><span class="c">%                  matrices are z-scored before estimating the regression</span>
<span class="w">    </span><span class="c">%                  coefficients.</span>
<span class="w">    </span><span class="c">%                  This option is required when &#39;target_dsm&#39; is not</span>
<span class="w">    </span><span class="c">%                  provided; it cannot cannot used together with the</span>
<span class="w">    </span><span class="c">%                  &#39;target_dsm&#39; or &#39;regress_dsm&#39; options.</span>
<span class="w">    </span><span class="c">%                  When using this option, the &#39;type&#39; option cannot be</span>
<span class="w">    </span><span class="c">%                  set to &#39;Spearman&#39; or &#39;Kendall&#39;.</span>
<span class="w">    </span><span class="c">%                  For this option, the output has as many rows (samples)</span>
<span class="w">    </span><span class="c">%                  as there are elements (dissimilarity matrices) in</span>
<span class="w">    </span><span class="c">%                  .glm_dsm.</span>
<span class="w">    </span><span class="c">%     .center_data If set to true, then the mean of each feature (column in</span>
<span class="w">    </span><span class="c">%                  ds.samples) is subtracted from each column prior to</span>
<span class="w">    </span><span class="c">%                  computing the pairwise distances for all samples in ds.</span>
<span class="w">    </span><span class="c">%                  This is generally recommended but is not the default in</span>
<span class="w">    </span><span class="c">%                  order to avoid breaking behavaiour from earlier</span>
<span class="w">    </span><span class="c">%                  versions. For a rationale why this is recommendable, see</span>
<span class="w">    </span><span class="c">%                  the Diedrichsen &amp; Kriegeskorte article (below in</span>
<span class="w">    </span><span class="c">%                  references)</span>
<span class="w">    </span><span class="c">%                  Default: false</span>
<span class="w">    </span><span class="c">%</span>
<span class="w">    </span><span class="c">% Output:</span>
<span class="w">    </span><span class="c">%    ds_sa         Dataset struct with fields:</span>
<span class="w">    </span><span class="c">%      .samples    Scalar correlation value between the pair-wise</span>
<span class="w">    </span><span class="c">%                  distances of the samples in ds and target_dsm; or</span>
<span class="w">    </span><span class="c">%                  (when &#39;glm_dsms&#39; is supplied) a column vector with</span>
<span class="w">    </span><span class="c">%                  normalized beta coefficients. These values</span>
<span class="w">    </span><span class="c">%                  are untransformed (e.g. there is no Fisher transform).</span>
<span class="w">    </span><span class="c">%      .sa         Struct with field:</span>
<span class="w">    </span><span class="c">%        .labels   {&#39;rho&#39;}; or (when &#39;glm_dsm&#39; is supplied) a cell</span>
<span class="w">    </span><span class="c">%                  {&#39;beta1&#39;,&#39;beta2&#39;,...}.</span>
<span class="w">    </span><span class="c">%</span>
<span class="w">    </span><span class="c">% Examples:</span>
<span class="w">    </span><span class="c">%     % generate synthetic dataset with 6 classes (conditions),</span>
<span class="w">    </span><span class="c">%     % one sample per class</span>
<span class="w">    </span><span class="c">%     ds=cosmo_synthetic_dataset(&#39;ntargets&#39;,6,&#39;nchunks&#39;,1);</span>
<span class="w">    </span><span class="c">%     %</span>
<span class="w">    </span><span class="c">%     % create target dissimilarity matrix to test whether</span>
<span class="w">    </span><span class="c">%     % - class 1 and 2 are similar (and different from classes 3-6)</span>
<span class="w">    </span><span class="c">%     % - class 3 and 4 are similar (and different from classes 1,2,5,6)</span>
<span class="w">    </span><span class="c">%     % - class 5 and 6 are similar (and different from classes 1-4)</span>
<span class="w">    </span><span class="c">%     target_dsm=1-kron(eye(3),ones(2));</span>
<span class="w">    </span><span class="c">%     %</span>
<span class="w">    </span><span class="c">%     % show the target dissimilarity matrix</span>
<span class="w">    </span><span class="c">%     cosmo_disp(target_dsm);</span>
<span class="w">    </span><span class="c">%     %|| [ 0         0         1         1         1         1</span>
<span class="w">    </span><span class="c">%     %||   0         0         1         1         1         1</span>
<span class="w">    </span><span class="c">%     %||   1         1         0         0         1         1</span>
<span class="w">    </span><span class="c">%     %||   1         1         0         0         1         1</span>
<span class="w">    </span><span class="c">%     %||   1         1         1         1         0         0</span>
<span class="w">    </span><span class="c">%     %||   1         1         1         1         0         0 ]</span>
<span class="w">    </span><span class="c">%     %</span>
<span class="w">    </span><span class="c">%     % compute similarity between pairw-wise similarity of the</span>
<span class="w">    </span><span class="c">%     % patterns in the dataset and the target dissimilarity matrix</span>
<span class="w">    </span><span class="c">%     dcm_ds=cosmo_target_dsm_corr_measure(ds,&#39;target_dsm&#39;,target_dsm);</span>
<span class="w">    </span><span class="c">%     %</span>
<span class="w">    </span><span class="c">%     % Pearson correlation is about 0.56</span>
<span class="w">    </span><span class="c">%     cosmo_disp(dcm_ds)</span>
<span class="w">    </span><span class="c">%     %|| .samples</span>
<span class="w">    </span><span class="c">%     %||   [ 0.562 ]</span>
<span class="w">    </span><span class="c">%     %|| .sa</span>
<span class="w">    </span><span class="c">%     %||   .labels</span>
<span class="w">    </span><span class="c">%     %||     { &#39;rho&#39; }</span>
<span class="w">    </span><span class="c">%     %||   .metric</span>
<span class="w">    </span><span class="c">%     %||     { &#39;correlation&#39; }</span>
<span class="w">    </span><span class="c">%     %||   .type</span>
<span class="w">    </span><span class="c">%     %||     { &#39;Pearson&#39; }</span>
<span class="w">    </span><span class="c">%     %</span>
<span class="w">    </span><span class="c">%     % do not consider classes 3 and 5</span>
<span class="w">    </span><span class="c">%     target_dsm([3,5],:)=NaN;</span>
<span class="w">    </span><span class="c">%     target_dsm(:,[3,5])=NaN;</span>
<span class="w">    </span><span class="c">%     target_dsm(3,3)=0;</span>
<span class="w">    </span><span class="c">%     target_dsm(5,5)=0;</span>
<span class="w">    </span><span class="c">%     %</span>
<span class="w">    </span><span class="c">%     % show the updated target dissimilarity matrix</span>
<span class="w">    </span><span class="c">%     cosmo_disp(target_dsm);</span>
<span class="w">    </span><span class="c">%     %|| [   0         0       NaN         1       NaN         1</span>
<span class="w">    </span><span class="c">%     %||     0         0       NaN         1       NaN         1</span>
<span class="w">    </span><span class="c">%     %||   NaN       NaN         0       NaN       NaN       NaN</span>
<span class="w">    </span><span class="c">%     %||     1         1       NaN         0       NaN         1</span>
<span class="w">    </span><span class="c">%     %||   NaN       NaN       NaN       NaN         0       NaN</span>
<span class="w">    </span><span class="c">%     %||     1         1       NaN         1       NaN         0 ]</span>
<span class="w">    </span><span class="c">%     %</span>
<span class="w">    </span><span class="c">%     % compute similarity between pairw-wise similarity of the</span>
<span class="w">    </span><span class="c">%     % patterns in the dataset and the target dissimilarity matrix</span>
<span class="w">    </span><span class="c">%     dcm_ds=cosmo_target_dsm_corr_measure(ds,&#39;target_dsm&#39;,target_dsm);</span>
<span class="w">    </span><span class="c">%     %</span>
<span class="w">    </span><span class="c">%     % Correlation is different because classes 3 and 5 were left out</span>
<span class="w">    </span><span class="c">%     cosmo_disp(dcm_ds)</span>
<span class="w">    </span><span class="c">%     %|| .samples</span>
<span class="w">    </span><span class="c">%     %||   [ 0.705 ]</span>
<span class="w">    </span><span class="c">%     %|| .sa</span>
<span class="w">    </span><span class="c">%     %||   .labels</span>
<span class="w">    </span><span class="c">%     %||     { &#39;rho&#39; }</span>
<span class="w">    </span><span class="c">%     %||   .metric</span>
<span class="w">    </span><span class="c">%     %||     { &#39;correlation&#39; }</span>
<span class="w">    </span><span class="c">%     %||   .type</span>
<span class="w">    </span><span class="c">%     %||     { &#39;Pearson&#39; }</span>
<span class="w">    </span><span class="c">%</span>
<span class="w">    </span><span class="c">%</span>
<span class="w">    </span><span class="c">%</span>
<span class="w">    </span><span class="c">% Notes:</span>
<span class="w">    </span><span class="c">%   - for group analysis, correlations can be fisher-transformed</span>
<span class="w">    </span><span class="c">%     through:</span>
<span class="w">    </span><span class="c">%       dcm_ds.samples=atanh(dcm_ds.samples)</span>
<span class="w">    </span><span class="c">%   - it is recommended to set the &#39;center_data&#39; to true when using</span>
<span class="w">    </span><span class="c">%     the default &#39;correlation&#39; metric, as this removes a main effect</span>
<span class="w">    </span><span class="c">%     common to all samples; but note that this option is disabled by</span>
<span class="w">    </span><span class="c">%     default due to historical reasons.</span>
<span class="w">    </span><span class="c">%   - elements in the *_dsm dissimilarity matrices can have NaNs, in which</span>
<span class="w">    </span><span class="c">%     case their value, as well as the corresponding location in the</span>
<span class="w">    </span><span class="c">%     dataset&#39;s samples, are ignored. Masking is done prior to z-score</span>
<span class="w">    </span><span class="c">%     normalization.</span>
<span class="w">    </span><span class="c">%</span>
<span class="w">    </span><span class="c">% Reference:</span>
<span class="w">    </span><span class="c">%   - Diedrichsen, J., &amp; Kriegeskorte, N. (2017). Representational</span>
<span class="w">    </span><span class="c">%     models: A common framework for understanding encoding,</span>
<span class="w">    </span><span class="c">%     pattern-component, and representational-similarity analysis.</span>
<span class="w">    </span><span class="c">%     PLoS computational biology, 13(4), e1005508.</span>
<span class="w">    </span><span class="c">%</span>
<span class="w">    </span><span class="c">%</span>
<span class="w">    </span><span class="c">% #   For CoSMoMVPA&#39;s copyright information and license terms,   #</span>
<span class="w">    </span><span class="c">% #   see the COPYING file distributed with CoSMoMVPA.           #</span>

<span class="w">    </span><span class="c">% process input arguments</span>
<span class="w">    </span><span class="n">params</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">cosmo_structjoin</span><span class="p">(</span><span class="s">&#39;type&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;Pearson&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                              </span><span class="s">&#39;metric&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;correlation&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                              </span><span class="s">&#39;center_data&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                              </span><span class="nb">varargin</span><span class="p">);</span>

<span class="w">    </span><span class="n">check_input</span><span class="p">(</span><span class="n">ds</span><span class="p">);</span>
<span class="w">    </span><span class="n">check_params</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>

<span class="w">    </span><span class="c">% - compute the pair-wise distance between all dataset samples using</span>
<span class="w">    </span><span class="c">%   cosmo_pdist</span>

<span class="w">    </span><span class="n">samples</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">ds</span><span class="p">.</span><span class="n">samples</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">params</span><span class="p">.</span><span class="n">center_data</span>
<span class="w">        </span><span class="n">samples</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">bsxfun</span><span class="p">(@</span><span class="n">minus</span><span class="p">,</span><span class="w"> </span><span class="n">samples</span><span class="p">,</span><span class="w"> </span><span class="nb">mean</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="n">samples_pdist</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">cosmo_pdist</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p">.</span><span class="n">metric</span><span class="p">)</span><span class="o">&#39;</span><span class="p">;</span>

<span class="w">    </span><span class="n">has_model_dsms</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">isfield</span><span class="p">(</span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;glm_dsm&#39;</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">has_model_dsms</span>
<span class="w">        </span><span class="n">ds_sa</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">linear_regression_dsm</span><span class="p">(</span><span class="n">samples_pdist</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p">);</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="n">ds_sa</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">correlation_dsm</span><span class="p">(</span><span class="n">samples_pdist</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p">);</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="n">check_output</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">ds_sa</span><span class="p">);</span>

<span class="k">function</span><span class="w"> </span><span class="nf">check_output</span><span class="p">(</span>input_ds, output_ds_sa<span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">any</span><span class="p">(</span><span class="nb">isnan</span><span class="p">(</span><span class="n">output_ds_sa</span><span class="p">.</span><span class="n">samples</span><span class="p">))</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nb">any</span><span class="p">(</span><span class="nb">isnan</span><span class="p">(</span><span class="n">input_ds</span><span class="p">.</span><span class="n">samples</span><span class="p">(:)))</span>
<span class="w">            </span><span class="n">msg</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="s">&#39;Input dataset has NaN values, which results in &#39;</span><span class="k">...</span>
<span class="w">                   </span><span class="s">&#39;NaN values in the output. Consider masking the &#39;</span><span class="k">...</span>
<span class="w">                   </span><span class="s">&#39;dataset to remove NaN values&#39;</span><span class="p">];</span>
<span class="w">        </span><span class="k">elseif</span><span class="w"> </span><span class="nb">any</span><span class="p">(</span><span class="nb">var</span><span class="p">(</span><span class="n">input_ds</span><span class="p">.</span><span class="n">samples</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">            </span><span class="n">msg</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="s">&#39;Input dataset has constant or infinite features, &#39;</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                   </span><span class="s">&#39;which results in NaN values in the output. &#39;</span><span class="k">...</span>
<span class="w">                   </span><span class="s">&#39;Consider masking the dataset to remove constant &#39;</span><span class="k">...</span>
<span class="w">                   </span><span class="s">&#39;or non-finite features, for example using &#39;</span><span class="k">...</span>
<span class="w">                   </span><span class="s">&#39;cosmo_remove_useless_data&#39;</span><span class="p">];</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span><span class="n">msg</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="s">&#39;Output has NaN values, even though the input does &#39;</span><span class="k">...</span>
<span class="w">                   </span><span class="s">&#39;not. This can be due to the presence of constant &#39;</span><span class="k">...</span>
<span class="w">                   </span><span class="s">&#39;features and/or non-finite values in the input, &#39;</span><span class="k">...</span>
<span class="w">                   </span><span class="s">&#39;and/or target similarity structures with constant &#39;</span><span class="k">...</span>
<span class="w">                   </span><span class="s">&#39;and/of non-finite data. When in doubt, please &#39;</span><span class="k">...</span>
<span class="w">                   </span><span class="s">&#39;contact the CoSMoMVPA developers&#39;</span><span class="p">];</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">        </span><span class="n">cosmo_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
<span class="w">    </span><span class="k">end</span>

<span class="k">function</span><span class="w"> </span>ds_sa<span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">correlation_dsm</span><span class="p">(</span>samples_pdist, params<span class="p">)</span>
<span class="w">    </span><span class="n">npairs_dataset</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">numel</span><span class="p">(</span><span class="n">samples_pdist</span><span class="p">);</span>

<span class="w">    </span><span class="c">% get target dsm in vector form</span>
<span class="w">    </span><span class="p">[</span><span class="n">target_dsm_vec</span><span class="p">,</span><span class="w"> </span><span class="n">target_msk</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">get_dsm_vec_from_struct</span><span class="p">(</span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                                                           </span><span class="s">&#39;target_dsm&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                                                           </span><span class="n">npairs_dataset</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">~</span><span class="nb">isempty</span><span class="p">(</span><span class="n">target_msk</span><span class="p">)</span>
<span class="w">        </span><span class="n">samples_pdist</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">samples_pdist</span><span class="p">(</span><span class="n">target_msk</span><span class="p">);</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="c">% ensure the size of the dataset matches the matrix</span>
<span class="w">    </span><span class="n">has_regress_dsm</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">isfield</span><span class="p">(</span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;regress_dsm&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">has_regress_dsm</span>
<span class="w">        </span><span class="p">[</span><span class="n">regress_dsm_mat</span><span class="p">,</span><span class="w"> </span><span class="n">regress_msk</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">get_dsm_mat_from_vector_or_cell</span><span class="p">(</span><span class="w"> </span><span class="k">...</span>
<span class="w">                                                                         </span><span class="n">params</span><span class="p">.</span><span class="n">regress_dsm</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                                                                         </span><span class="n">npairs_dataset</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">~</span><span class="nb">isequal</span><span class="p">(</span><span class="n">target_msk</span><span class="p">,</span><span class="w"> </span><span class="n">regress_msk</span><span class="p">)</span>
<span class="w">            </span><span class="nb">error</span><span class="p">([</span><span class="s">&#39;NaN mask non-match between &#39;&#39;target_dsm&#39;&#39; &#39;</span><span class="k">...</span>
<span class="w">                   </span><span class="s">&#39;and &#39;&#39;regress_dsm&#39;&#39;&#39;</span><span class="p">]);</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="p">[</span><span class="n">samples_pdist</span><span class="p">(:),</span><span class="w"> </span><span class="n">target_dsm_vec</span><span class="p">(:)]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">regress_out</span><span class="p">(</span><span class="w"> </span><span class="k">...</span>
<span class="w">                                                            </span><span class="n">samples_pdist</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                                                            </span><span class="n">target_dsm_vec</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                                                            </span><span class="n">regress_dsm_mat</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                                                            </span><span class="n">params</span><span class="p">.</span><span class="n">type</span><span class="p">);</span>
<span class="w">        </span><span class="c">% regressed out samples are either based on Pearson or Spearman</span>
<span class="w">        </span><span class="c">% correlation; Pearson correlations are computed for the final</span>
<span class="w">        </span><span class="c">% correlation computation</span>
<span class="w">        </span><span class="n">corr_type</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;Pearson&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="n">corr_type</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">params</span><span class="p">.</span><span class="n">type</span><span class="p">;</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="n">rho</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">cosmo_corr</span><span class="p">(</span><span class="n">samples_pdist</span><span class="p">,</span><span class="w"> </span><span class="n">target_dsm_vec</span><span class="p">,</span><span class="w"> </span><span class="n">corr_type</span><span class="p">);</span>

<span class="w">    </span><span class="c">% store results</span>
<span class="w">    </span><span class="n">ds_sa</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">struct</span><span class="p">();</span>
<span class="w">    </span><span class="n">ds_sa</span><span class="p">.</span><span class="n">samples</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">rho</span><span class="p">;</span>
<span class="w">    </span><span class="n">ds_sa</span><span class="p">.</span><span class="n">sa</span><span class="p">.</span><span class="n">labels</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="s">&#39;rho&#39;</span><span class="p">};</span>
<span class="w">    </span><span class="n">ds_sa</span><span class="p">.</span><span class="n">sa</span><span class="p">.</span><span class="n">metric</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="n">params</span><span class="p">.</span><span class="n">metric</span><span class="p">};</span>
<span class="w">    </span><span class="n">ds_sa</span><span class="p">.</span><span class="n">sa</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="n">params</span><span class="p">.</span><span class="n">type</span><span class="p">};</span>

<span class="k">function</span><span class="w"> </span>ds_sa<span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">linear_regression_dsm</span><span class="p">(</span>samples_pdist, params<span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">~</span><span class="nb">strcmp</span><span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;Pearson&#39;</span><span class="p">)</span>
<span class="w">        </span><span class="nb">error</span><span class="p">([</span><span class="s">&#39;For linear regression, only &#39;&#39;Pearson&#39;&#39; is &#39;</span><span class="k">...</span>
<span class="w">               </span><span class="s">&#39;currently allowed&#39;</span><span class="p">]);</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="n">npairs_dataset</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">numel</span><span class="p">(</span><span class="n">samples_pdist</span><span class="p">);</span>

<span class="w">    </span><span class="p">[</span><span class="n">dsm_mat</span><span class="p">,</span><span class="w"> </span><span class="n">msk</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">get_dsm_mat_from_vector_or_cell</span><span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">glm_dsm</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                                                     </span><span class="n">npairs_dataset</span><span class="p">);</span>

<span class="w">    </span><span class="c">% normalize matrices</span>
<span class="w">    </span><span class="n">dsm_mat_zscore</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">cosmo_normalize</span><span class="p">(</span><span class="n">dsm_mat</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;zscore&#39;</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">~</span><span class="nb">isempty</span><span class="p">(</span><span class="n">msk</span><span class="p">)</span>
<span class="w">        </span><span class="n">samples_pdist</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">samples_pdist</span><span class="p">(</span><span class="n">msk</span><span class="p">);</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="c">% normalize data</span>
<span class="w">    </span><span class="n">samples_pdist_zscore</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">cosmo_normalize</span><span class="p">(</span><span class="n">samples_pdist</span><span class="p">(:),</span><span class="w"> </span><span class="s">&#39;zscore&#39;</span><span class="p">);</span>

<span class="w">    </span><span class="c">% estimate betas based on masked samples</span>
<span class="w">    </span><span class="n">betas</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">dsm_mat_zscore</span><span class="w"> </span><span class="o">\</span><span class="w"> </span><span class="n">samples_pdist_zscore</span><span class="p">;</span>

<span class="w">    </span><span class="c">% construct labels</span>
<span class="w">    </span><span class="n">nvec</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">size</span><span class="p">(</span><span class="n">dsm_mat_zscore</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="w">    </span><span class="n">labels</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">cell</span><span class="p">(</span><span class="n">nvec</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">nvec</span>
<span class="w">        </span><span class="n">labels</span><span class="p">{</span><span class="n">k</span><span class="p">}</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">sprintf</span><span class="p">(</span><span class="s">&#39;beta%d&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">);</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="n">ds_sa</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">struct</span><span class="p">();</span>
<span class="w">    </span><span class="n">ds_sa</span><span class="p">.</span><span class="n">samples</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">betas</span><span class="p">;</span>
<span class="w">    </span><span class="n">ds_sa</span><span class="p">.</span><span class="n">sa</span><span class="p">.</span><span class="n">labels</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">labels</span><span class="p">;</span>
<span class="w">    </span><span class="n">ds_sa</span><span class="p">.</span><span class="n">sa</span><span class="p">.</span><span class="n">metric</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">repmat</span><span class="p">({</span><span class="n">params</span><span class="p">.</span><span class="n">metric</span><span class="p">},</span><span class="w"> </span><span class="n">nvec</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>

<span class="k">function</span><span class="err"> [</span><span class="nf">ds_resid</span><span class="p">,</span><span class="w"> </span><span class="n">target_resid</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">regress_out</span><span class="p">(</span><span class="n">ds_pdist</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                                                </span><span class="n">target_dsm_vec</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                                                </span><span class="n">regress_dsm_mat</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                                                </span><span class="n">partial_corr_type</span><span class="p">)</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">strcmp</span><span class="p">(</span><span class="n">partial_corr_type</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;Spearman&#39;</span><span class="p">)</span>
<span class="w">        </span><span class="c">% use ranks of the dissimilarity matrices</span>
<span class="w">        </span><span class="n">ds_pdist</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">cosmo_tiedrank</span><span class="p">(</span><span class="n">ds_pdist</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">target_dsm_vec</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">cosmo_tiedrank</span><span class="p">(</span><span class="n">target_dsm_vec</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">regress_dsm_mat</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">cosmo_tiedrank</span><span class="p">(</span><span class="n">regress_dsm_mat</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="k">elseif</span><span class="w"> </span><span class="nb">strcmp</span><span class="p">(</span><span class="n">partial_corr_type</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;Kendall&#39;</span><span class="p">)</span>
<span class="w">        </span><span class="nb">error</span><span class="p">(</span><span class="s">&#39;Kendall cannot be used with the &#39;&#39;regress_dsm&#39;&#39; option&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="c">% set up design matrix</span>
<span class="w">    </span><span class="n">nsamples</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">size</span><span class="p">(</span><span class="n">ds_pdist</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="n">regr</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="n">regress_dsm_mat</span><span class="w"> </span><span class="nb">ones</span><span class="p">(</span><span class="n">nsamples</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)];</span>

<span class="w">    </span><span class="c">% put ds_pdist and target_dsm_vec together</span>
<span class="w">    </span><span class="n">both</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="n">ds_pdist</span><span class="w"> </span><span class="n">target_dsm_vec</span><span class="p">];</span>

<span class="w">    </span><span class="c">% compute residuals</span>
<span class="w">    </span><span class="n">both_resid</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">both</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">regr</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">regr</span><span class="w"> </span><span class="o">\</span><span class="w"> </span><span class="n">both</span><span class="p">);</span>

<span class="w">    </span><span class="n">ds_resid</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">both_resid</span><span class="p">(:,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="n">target_resid</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">both_resid</span><span class="p">(:,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>

<span class="k">function</span><span class="err"> [</span><span class="nf">dsm_mat</span><span class="p">,</span><span class="w"> </span><span class="n">common_msk</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">get_dsm_mat_from_vector_or_cell</span><span class="p">(</span><span class="n">dsm_cell</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                                                                 </span><span class="n">npairs_dataset</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">isnumeric</span><span class="p">(</span><span class="n">dsm_cell</span><span class="p">)</span>
<span class="w">        </span><span class="n">dsm_cell</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="n">dsm_cell</span><span class="p">};</span>
<span class="w">    </span><span class="k">elseif</span><span class="w"> </span><span class="o">~</span><span class="nb">iscell</span><span class="p">(</span><span class="n">dsm_cell</span><span class="p">)</span>
<span class="w">        </span><span class="nb">error</span><span class="p">(</span><span class="s">&#39;dsm inputs must be provided in a cell&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="n">n</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">numel</span><span class="p">(</span><span class="n">dsm_cell</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">n</span>
<span class="w">        </span><span class="n">name</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">sprintf</span><span class="p">(</span><span class="s">&#39;.model_dsms{%d}&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">);</span>
<span class="w">        </span><span class="p">[</span><span class="n">vec</span><span class="p">,</span><span class="w"> </span><span class="n">msk_k</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">get_dsm_vec</span><span class="p">(</span><span class="n">dsm_cell</span><span class="p">{</span><span class="n">k</span><span class="p">},</span><span class="w"> </span><span class="n">npairs_dataset</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span>
<span class="w">            </span><span class="n">nrows</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">numel</span><span class="p">(</span><span class="n">vec</span><span class="p">);</span>
<span class="w">            </span><span class="n">dsm_mat</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>

<span class="w">            </span><span class="n">common_msk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">msk_k</span><span class="p">;</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">~</span><span class="nb">isempty</span><span class="p">(</span><span class="n">msk_k</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">~=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">~</span><span class="nb">isequal</span><span class="p">(</span><span class="n">common_msk</span><span class="p">,</span><span class="w"> </span><span class="n">msk_k</span><span class="p">)</span>
<span class="w">            </span><span class="nb">error</span><span class="p">(</span><span class="s">&#39;DSMs NaN mask mismatch for matrices %d and %d&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                  </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">);</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="n">dsm_mat</span><span class="p">(:,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">vec</span><span class="p">;</span>
<span class="w">    </span><span class="k">end</span>

<span class="k">function</span><span class="w"> </span><span class="nf">[dsm_vec, msk] = get_dsm_vec_from_struct</span><span class="p">(</span>params, name, npairs_dataset<span class="p">)</span>
<span class="w">    </span><span class="c">% helper function to get dsm in vector form</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">~</span><span class="nb">isfield</span><span class="p">(</span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">)</span>
<span class="w">        </span><span class="nb">error</span><span class="p">(</span><span class="s">&#39;Missing parameter &#39;&#39;%s&#39;&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">);</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="n">dsm</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">params</span><span class="p">.(</span><span class="n">name</span><span class="p">);</span>
<span class="w">    </span><span class="p">[</span><span class="n">dsm_vec</span><span class="p">,</span><span class="w"> </span><span class="n">msk</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">get_dsm_vec</span><span class="p">(</span><span class="n">dsm</span><span class="p">,</span><span class="w"> </span><span class="n">npairs_dataset</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s">&#39;&#39;&#39;&#39;</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="s">&#39;&#39;&#39;&#39;</span><span class="p">]);</span>

<span class="k">function</span><span class="w"> </span><span class="nf">[dsm_vec, msk] = get_dsm_vec</span><span class="p">(</span>dsm, npairs_dataset, name<span class="p">)</span>
<span class="w">    </span><span class="c">% helper function to get dsm in column vector form</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">~</span><span class="nb">isnumeric</span><span class="p">(</span><span class="n">dsm</span><span class="p">)</span>
<span class="w">        </span><span class="nb">error</span><span class="p">(</span><span class="s">&#39;dsm inputs must be numeric, found %s&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">class</span><span class="p">(</span><span class="n">dsm</span><span class="p">));</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="n">sz</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">size</span><span class="p">(</span><span class="n">dsm</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">sz</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="n">dsm_vec</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">dsm</span><span class="o">&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">elseif</span><span class="w"> </span><span class="n">sz</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="n">dsm_vec</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">dsm</span><span class="p">;</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="c">% convert square matrix to vector</span>
<span class="w">        </span><span class="n">dsm_vec</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">cosmo_squareform</span><span class="p">(</span><span class="n">dsm</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;tovector&#39;</span><span class="p">)</span><span class="o">&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">npairs_dataset</span><span class="w"> </span><span class="o">~=</span><span class="w"> </span><span class="nb">numel</span><span class="p">(</span><span class="n">dsm_vec</span><span class="p">)</span>
<span class="w">        </span><span class="nb">error</span><span class="p">([</span><span class="s">&#39;Sample size mismatch between dataset (%d pairs) &#39;</span><span class="k">...</span>
<span class="w">               </span><span class="s">&#39;and %s in vector form (%d pairs)&#39;</span><span class="p">],</span><span class="w"> </span><span class="k">...</span>
<span class="w">              </span><span class="n">npairs_dataset</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="nb">numel</span><span class="p">(</span><span class="n">dsm_vec</span><span class="p">));</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="n">msk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[];</span>

<span class="w">    </span><span class="n">nan_msk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">isnan</span><span class="p">(</span><span class="n">dsm_vec</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">any</span><span class="p">(</span><span class="n">nan_msk</span><span class="p">)</span>
<span class="w">        </span><span class="c">% apply mask</span>
<span class="w">        </span><span class="n">msk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="o">~</span><span class="n">nan_msk</span><span class="p">;</span>
<span class="w">        </span><span class="n">dsm_vec</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">dsm_vec</span><span class="p">(</span><span class="n">msk</span><span class="p">);</span>
<span class="w">    </span><span class="k">end</span>

<span class="k">function</span><span class="w"> </span><span class="nf">check_input</span><span class="p">(</span>ds<span class="p">)</span>
<span class="w">    </span><span class="c">% for safety require targets to be 1:N</span>
<span class="w">    </span><span class="n">has_sa</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">isstruct</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">isfield</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;sa&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">~</span><span class="n">has_sa</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">~</span><span class="nb">isfield</span><span class="p">(</span><span class="n">ds</span><span class="p">.</span><span class="n">sa</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;targets&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">~</span><span class="nb">isfield</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;samples&#39;</span><span class="p">)</span>
<span class="w">        </span><span class="nb">error</span><span class="p">(</span><span class="s">&#39;Missing field .sa.targets or .samples&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="n">nsamples</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">size</span><span class="p">(</span><span class="n">ds</span><span class="p">.</span><span class="n">samples</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">~</span><span class="nb">isequal</span><span class="p">(</span><span class="n">ds</span><span class="p">.</span><span class="n">sa</span><span class="p">.</span><span class="n">targets</span><span class="o">&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">nsamples</span><span class="p">)</span>
<span class="w">        </span><span class="n">msg</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">sprintf</span><span class="p">(</span><span class="s">&#39;.sa.targets must be (1:%d)&#39;&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">nsamples</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nb">isequal</span><span class="p">(</span><span class="nb">unique</span><span class="p">(</span><span class="n">ds</span><span class="p">.</span><span class="n">sa</span><span class="p">.</span><span class="n">targets</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nsamples</span><span class="p">)</span><span class="o">&#39;</span><span class="p">)</span>
<span class="w">            </span><span class="n">msg</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">sprintf</span><span class="p">([</span><span class="s">&#39;%s\nMultiple samples with the same chunks &#39;</span><span class="k">...</span>
<span class="w">                           </span><span class="s">&#39;can be averaged using cosmo_fx&#39;</span><span class="p">],</span><span class="w"> </span><span class="n">msg</span><span class="p">);</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span><span class="n">msg</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">sprintf</span><span class="p">([</span><span class="s">&#39;%s\nConsider setting .sa.chunks to q, where &#39;</span><span class="k">...</span>
<span class="w">                           </span><span class="s">&#39;[~,~,q]=unique(ds.sa.targets)&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">]);</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">        </span><span class="nb">error</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
<span class="w">    </span><span class="k">end</span>

<span class="k">function</span><span class="w"> </span><span class="nf">check_params</span><span class="p">(</span>params<span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">isfield</span><span class="p">(</span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;glm_dsm&#39;</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nb">isfield</span><span class="p">(</span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;regress_dsm&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">isfield</span><span class="p">(</span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;target_dsm&#39;</span><span class="p">)</span>
<span class="w">            </span><span class="nb">error</span><span class="p">([</span><span class="s">&#39;&#39;&#39;glm_dsm&#39;&#39; cannot be used with &#39;&#39;regress_dsm&#39;&#39;&#39;</span><span class="k">...</span>
<span class="w">                   </span><span class="s">&#39;or &#39;&#39;target_dsm&#39;&#39;&#39;</span><span class="p">]);</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">    </span><span class="k">elseif</span><span class="w"> </span><span class="o">~</span><span class="nb">isfield</span><span class="p">(</span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;target_dsm&#39;</span><span class="p">)</span>
<span class="w">        </span><span class="nb">error</span><span class="p">(</span><span class="s">&#39;&#39;&#39;target_dsm&#39;&#39; or &#39;&#39;glm_dsm&#39;&#39; option is required&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="n">ensure_is_valid_correlation</span><span class="p">(</span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;type&#39;</span><span class="p">);</span>

<span class="k">function</span><span class="w"> </span><span class="nf">ensure_is_valid_correlation</span><span class="p">(</span>params, key<span class="p">)</span>
<span class="w">    </span><span class="n">value</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">params</span><span class="p">.(</span><span class="n">key</span><span class="p">);</span>

<span class="w">    </span><span class="n">allowed_types</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="s">&#39;Spearman&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;Pearson&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;Kendall&#39;</span><span class="p">};</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">~</span><span class="p">(</span><span class="nb">ischar</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="k">...</span>
<span class="w">         </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">any</span><span class="p">(</span><span class="nb">strcmp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">allowed_types</span><span class="p">)))</span>
<span class="w">        </span><span class="nb">error</span><span class="p">(</span><span class="s">&#39;&#39;&#39;%s&#39;&#39; argument must be one of: &#39;&#39;%s&#39;&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">              </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">cosmo_strjoin</span><span class="p">(</span><span class="n">allowed_types</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;&#39;&#39;%s&#39;&#39;, &#39;</span><span class="p">));</span>
<span class="w">    </span><span class="k">end</span>
</pre></div>
</div>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/cosmomvpa_logo.png" alt="Logo of CoSMo Multivariate Pattern Analysis toolbox"/>
            </a></p>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="cosmo_tail_skl.html"
                          title="previous chapter">cosmo tail skl</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="cosmo_tiedrank_skl.html"
                          title="next chapter">cosmo tiedrank skl</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/matlab/cosmo_target_dsm_corr_measure_skl.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="cosmo_tiedrank_skl.html" title="cosmo tiedrank skl"
             >next</a> |</li>
        <li class="right" >
          <a href="cosmo_tail_skl.html" title="cosmo tail skl"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">CoSMoMVPA</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../documentation.html" >Documentation</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../nmsm2019.html" >NMSM 2019, Noesselt’s lab 3rd Modelling Symposium, University of Magdeburg</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="../matindex_skl.html" >CoSMoMVPA functions - skeleton files</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">cosmo target dsm corr measure skl</a></li> 
      </ul>
    </div>
      <div class="footer">
       <span class="creativecommons">
          <a href="http://opensource.org/licenses/MIT" >
          <img src="../_static/mit-license_logo.png"
               border="0" alt="Creative Commons License"/>
         </a> 
         
        <a href="copyright.html">Copyright 2013-2021 Nikolaas N. Oosterhof, Andrew C. Connolly, CoSMoMVPA contributors</a>.
        CoSMoMVPA is licensed under an <a href="http://opensource.org/licenses/MIT">Expat (MIT) License</a>.
       </span>
      </div>
  </body>
</html>