    <!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>cosmo meeg dataset &#8212; CoSMo Multivariate Pattern Analysis toolbox 1.0rc1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=83e35b93" />
    <link rel="stylesheet" type="text/css" href="../_static/nature.css?v=279e0f84" />
    <script src="../_static/documentation_options.js?v=b2dc1058"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="next" title="cosmo meeg find layout" href="cosmo_meeg_find_layout.html" />
    <link rel="prev" title="cosmo meeg chantype" href="cosmo_meeg_chantype.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="cosmo_meeg_find_layout.html" title="cosmo meeg find layout"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="cosmo_meeg_chantype.html" title="cosmo meeg chantype"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">CoSMoMVPA</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../documentation.html" >Documentation</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../nmsm2019.html" >NMSM 2019, Noesselt’s lab 3rd Modelling Symposium, University of Magdeburg</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="../matindex.html" accesskey="U">CoSMoMVPA functions</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">cosmo meeg dataset</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="cosmo-meeg-dataset">
<span id="id1"></span><h1>cosmo meeg dataset<a class="headerlink" href="#cosmo-meeg-dataset" title="Link to this heading">¶</a></h1>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span>ds<span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">cosmo_meeg_dataset</span><span class="p">(</span>filename, varargin<span class="p">)</span>
<span class="w">    </span><span class="c">% Returns a dataset structure based on MEEG data</span>
<span class="w">    </span><span class="c">%</span>
<span class="w">    </span><span class="c">% ds=cosmo_meeg_dataset(filename, varargin)</span>
<span class="w">    </span><span class="c">%</span>
<span class="w">    </span><span class="c">% Inputs:</span>
<span class="w">    </span><span class="c">%   filename          filename of MEEG data to be loaded. Currently</span>
<span class="w">    </span><span class="c">%                     supported are files with extensions:</span>
<span class="w">    </span><span class="c">%                       .mat :        FieldTrip time-locked or</span>
<span class="w">    </span><span class="c">%                                     time-frequency  data at  either the</span>
<span class="w">    </span><span class="c">%                                     sensor or source level.</span>
<span class="w">    </span><span class="c">%                       .txt :        exported EEGLab with time-locked</span>
<span class="w">    </span><span class="c">%                                     data.</span>
<span class="w">    </span><span class="c">%                       .daterp       time-locked               }</span>
<span class="w">    </span><span class="c">%                       .icaerp       ICA time-locked           } EEGLab</span>
<span class="w">    </span><span class="c">%                       .dattimef     time-freq                 }</span>
<span class="w">    </span><span class="c">%                       .icatimef     ICA time-freq             }</span>
<span class="w">    </span><span class="c">%                       .datitc       inter-trial coherence     }</span>
<span class="w">    </span><span class="c">%                       .icaitc       ICA inter-trial coherence }</span>
<span class="w">    </span><span class="c">%                       .datersp      ERSP data                 }</span>
<span class="w">    </span><span class="c">%                       .icaersp      ICA ERSP data             }</span>
<span class="w">    </span><span class="c">%                     Alternatively it can be a FieldTrip or EEGLab struct</span>
<span class="w">    </span><span class="c">%                     with time-locked or time-frequency data</span>
<span class="w">    </span><span class="c">%   &#39;targets&#39;, t      Px1 targets for P samples; these will be stored in</span>
<span class="w">    </span><span class="c">%                     the output as ds.sa.targets (optional)</span>
<span class="w">    </span><span class="c">%   &#39;chunks&#39;, c       Px1 chunks for P samples; these will be stored in the</span>
<span class="w">    </span><span class="c">%                     the output as ds.sa.chunks (optional)</span>
<span class="w">    </span><span class="c">%   &#39;data_field&#39;, f   - For FieldTrip MEEG source dataset with multiple</span>
<span class="w">    </span><span class="c">%                       data fields (such as &#39;pow&#39; and &#39;mom&#39;), this sets</span>
<span class="w">    </span><span class="c">%                       which data is returned. (only for source data)</span>
<span class="w">    </span><span class="c">%                     - For EEGLAB &#39;ersp&#39; data</span>
<span class="w">    </span><span class="c">%                        f=&#39;ersp&#39;       the original data is returned</span>
<span class="w">    </span><span class="c">%                                       (without baseline correction),</span>
<span class="w">    </span><span class="c">%                                       with data for each channel,</span>
<span class="w">    </span><span class="c">%                                       frequency and time point.</span>
<span class="w">    </span><span class="c">%                                       Based on datasets generated by</span>
<span class="w">    </span><span class="c">%                                       EEGLAB that were inspected when</span>
<span class="w">    </span><span class="c">%                                       writing this function, it seems</span>
<span class="w">    </span><span class="c">%                                       that this data represents raw power</span>
<span class="w">    </span><span class="c">%                                       values.</span>
<span class="w">    </span><span class="c">%                        f=&#39;erspbase&#39;   the baseline is returned, with data</span>
<span class="w">    </span><span class="c">%                                       for each channel and frequency</span>
<span class="w">    </span><span class="c">%                                       (but not time point)</span>
<span class="w">    </span><span class="c">%                        Note: this function does currently not support</span>
<span class="w">    </span><span class="c">%                              returning baseline-corrected data.</span>
<span class="w">    </span><span class="c">%   &#39;trials&#39;, idx     Mx1 array with indices of trials to load (optional).</span>
<span class="w">    </span><span class="c">%                     If not provided then all trials are loaded. The</span>
<span class="w">    </span><span class="c">%                     output has a .samples field with the number of rows</span>
<span class="w">    </span><span class="c">%                     equal to numel(idx).</span>
<span class="w">    </span><span class="c">%</span>
<span class="w">    </span><span class="c">% Returns:</span>
<span class="w">    </span><span class="c">%   ds                dataset struct with the following fields</span>
<span class="w">    </span><span class="c">%     .samples        PxQ for P samples and Q features.</span>
<span class="w">    </span><span class="c">%     .sa.targets     Px1 sample targets (if provided)</span>
<span class="w">    </span><span class="c">%     .sa.chunks      Px1 sample chunks (if provided)</span>
<span class="w">    </span><span class="c">%     .a</span>
<span class="w">    </span><span class="c">%       .meeg</span>
<span class="w">    </span><span class="c">%         .sample_field   name of sample field. One of &#39;fourierspctrm&#39;,</span>
<span class="w">    </span><span class="c">%                         &#39;powspctrm&#39;, or &#39;trial&#39;.</span>
<span class="w">    </span><span class="c">%         .samples_type   &#39;timelock&#39; or &#39;timefreq&#39;.</span>
<span class="w">    </span><span class="c">%         .samples_label  Usually &#39;rpt&#39;; or the first field of .dimord</span>
<span class="w">    </span><span class="c">%                         for FieldTrip data</span>
<span class="w">    </span><span class="c">%       .dim</span>
<span class="w">    </span><span class="c">%         .labels     1xS cell struct with labels for the feature</span>
<span class="w">    </span><span class="c">%                     dimensions of the input. Usually this is</span>
<span class="w">    </span><span class="c">%                     {&#39;chan&#39;,&#39;time&#39;} or {&#39;chan&#39;,&#39;freq&#39;,&#39;time&#39;}.</span>
<span class="w">    </span><span class="c">%         .values     1xS cell struct with values associated with .labels.</span>
<span class="w">    </span><span class="c">%                     If the K-th value has N_K values, this means that</span>
<span class="w">    </span><span class="c">%                     the feature dimension .labels{K} takes the</span>
<span class="w">    </span><span class="c">%                     values in .values{K}. For example, if</span>
<span class="w">    </span><span class="c">%                     .labels{1}==&#39;chan&#39;, then .values{1} contains the</span>
<span class="w">    </span><span class="c">%                     channel labels.</span>
<span class="w">    </span><span class="c">%     .fa</span>
<span class="w">    </span><span class="c">%       .{D}          if D==a.fdim.labels{K} is the label for the K-th</span>
<span class="w">    </span><span class="c">%                     feature dimension, then .{D} contains the</span>
<span class="w">    </span><span class="c">%                     indices referencing a.fdim.values. Thus, all values in</span>
<span class="w">    </span><span class="c">%                     .{D} are in the range 1:N_K if a.fdim.values{K} has</span>
<span class="w">    </span><span class="c">%                     N_K values, and the J-th feature has dimension value</span>
<span class="w">    </span><span class="c">%                     .dim.values{K}(.{D}(J)) in the K-th dimension.</span>
<span class="w">    </span><span class="c">%</span>
<span class="w">    </span><span class="c">% Notes:</span>
<span class="w">    </span><span class="c">%  - The resulting dataset can be mapped back to MEEG format using</span>
<span class="w">    </span><span class="c">%    cosmo_map2meeg</span>
<span class="w">    </span><span class="c">%  - if the input contains data from a single sample (such as an average)</span>
<span class="w">    </span><span class="c">%    the .sample_field is set to .trial, and mapping back to MEEG format</span>
<span class="w">    </span><span class="c">%    adds a singleton dimension to the .trial data output field.</span>
<span class="w">    </span><span class="c">%  - For single-subject MVPA of single trials using data preprocessed with</span>
<span class="w">    </span><span class="c">%    FieldTrip, consider setting, depending on the data type:</span>
<span class="w">    </span><span class="c">%       * timelock (ft_timelockanalysis): cfg.keeptrials = &#39;yes&#39;</span>
<span class="w">    </span><span class="c">%       * timefreq (ft_timefreqanalysis): cfg.keeptrials = &#39;yes&#39;</span>
<span class="w">    </span><span class="c">%       * source   (ft_sourceanalysis)  : cfg.keeptrials = &#39;yes&#39; *and*</span>
<span class="w">    </span><span class="c">%                                                   cfg.rawtrials = &#39;yes&#39;</span>
<span class="w">    </span><span class="c">%  - Most MVPA applications require that .sa.targets (experimental</span>
<span class="w">    </span><span class="c">%    condition of each sample) and .sa.chunks (partitioning of the samples</span>
<span class="w">    </span><span class="c">%    in independent sets) are set, either by using this function or</span>
<span class="w">    </span><span class="c">%    manually afterwards.</span>
<span class="w">    </span><span class="c">%  - If the input is a FieldTrip struct with a field .trialinfo, then this</span>
<span class="w">    </span><span class="c">%    field is present in .sa.trialinfo. Depending on the contents of</span>
<span class="w">    </span><span class="c">%    .trialinfo, this could be used to specify conditions in each trial.</span>
<span class="w">    </span><span class="c">%    For example, if the third column of .trialinfo contains an integer</span>
<span class="w">    </span><span class="c">%    specifying the condition of each trial, after running this function</span>
<span class="w">    </span><span class="c">%    one can do</span>
<span class="w">    </span><span class="c">%</span>
<span class="w">    </span><span class="c">%       ds.sa.targets=ds.sa.trialinfo(:,3)</span>
<span class="w">    </span><span class="c">%</span>
<span class="w">    </span><span class="c">%    to set the trial conditions.</span>
<span class="w">    </span><span class="c">%  - Implementation note: when loading EEGLAB data from a file, using the</span>
<span class="w">    </span><span class="c">%    &#39;trials&#39; option means that data from different channels are loaded</span>
<span class="w">    </span><span class="c">%    through different &#39;load&#39; commands. When loading a subset of all</span>
<span class="w">    </span><span class="c">%    trials, the advantage of this implementation is that significant</span>
<span class="w">    </span><span class="c">%    less memory is needed compared to an alternative implementation in</span>
<span class="w">    </span><span class="c">%    which the full dataset is loaded and then the trials of interest</span>
<span class="w">    </span><span class="c">%    are selected through slicing. The disadvantage is that loading may</span>
<span class="w">    </span><span class="c">%    take longer, because the file is opened and closed multiple times. yet</span>
<span class="w">    </span><span class="c">%    this approach allows one to load subsets of trials from data files</span>
<span class="w">    </span><span class="c">%    that are larger than the available RAM.</span>
<span class="w">    </span><span class="c">%    Such memory reductions are currently not available for FieldTrip</span>
<span class="w">    </span><span class="c">%    data, as FieldTrip&#39;s data structures do not store data for different</span>
<span class="w">    </span><span class="c">%    channels in different variables.</span>
<span class="w">    </span><span class="c">%</span>
<span class="w">    </span><span class="c">% See also: cosmo_map2meeg</span>
<span class="w">    </span><span class="c">%</span>
<span class="w">    </span><span class="c">% #   For CoSMoMVPA&#39;s copyright information and license terms,   #</span>
<span class="w">    </span><span class="c">% #   see the COPYING file distributed with CoSMoMVPA.           #</span>

<span class="w">    </span><span class="c">% Input parsing stuff</span>

<span class="w">    </span><span class="n">defaults</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">struct</span><span class="p">();</span>
<span class="w">    </span><span class="n">defaults</span><span class="p">.</span><span class="n">targets</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="n">defaults</span><span class="p">.</span><span class="n">chunks</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[];</span>

<span class="w">    </span><span class="n">params</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">cosmo_structjoin</span><span class="p">(</span><span class="n">defaults</span><span class="p">,</span><span class="w"> </span><span class="nb">varargin</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">cosmo_check_dataset</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;meeg&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">)</span>
<span class="w">        </span><span class="c">% it is already a dataset</span>
<span class="w">        </span><span class="n">ds</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">filename</span><span class="p">;</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="c">% get image format and verify it is supported</span>
<span class="w">        </span><span class="n">img_format</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">get_img_format</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
<span class="w">        </span><span class="n">supported_image_formats</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">get_supported_image_formats</span><span class="p">();</span>

<span class="w">        </span><span class="c">% check externals</span>
<span class="w">        </span><span class="n">cosmo_check_external</span><span class="p">(</span><span class="n">supported_image_formats</span><span class="p">.(</span><span class="n">img_format</span><span class="p">).</span><span class="n">externals</span><span class="p">);</span>

<span class="w">        </span><span class="c">% get the reader</span>
<span class="w">        </span><span class="n">reader</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">supported_image_formats</span><span class="p">.(</span><span class="n">img_format</span><span class="p">).</span><span class="n">reader</span><span class="p">;</span>

<span class="w">        </span><span class="c">% read the dataset</span>
<span class="w">        </span><span class="n">ds</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">reader</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p">);</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="c">% set targets and chunks</span>
<span class="w">    </span><span class="n">ds</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">set_vec_sa</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;targets&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p">.</span><span class="n">targets</span><span class="p">);</span>
<span class="w">    </span><span class="n">ds</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">set_vec_sa</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;chunks&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p">.</span><span class="n">chunks</span><span class="p">);</span>

<span class="w">    </span><span class="c">% check consistency</span>
<span class="w">    </span><span class="n">cosmo_check_dataset</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;meeg&#39;</span><span class="p">);</span>

<span class="w">    </span><span class="c">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="w">    </span><span class="c">% general helper functions</span>
<span class="w">    </span><span class="c">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="k">function</span><span class="w"> </span>ds<span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">set_vec_sa</span><span class="p">(</span>ds, label, values<span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">isempty</span><span class="p">(</span><span class="nb">values</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">numel</span><span class="p">(</span><span class="nb">values</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="n">nsamples</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">size</span><span class="p">(</span><span class="n">ds</span><span class="p">.</span><span class="n">samples</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="nb">values</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">repmat</span><span class="p">(</span><span class="nb">values</span><span class="p">,</span><span class="w"> </span><span class="n">nsamples</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="n">ds</span><span class="p">.</span><span class="n">sa</span><span class="p">.(</span><span class="n">label</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">values</span><span class="p">(:);</span>

<span class="k">function</span><span class="w"> </span>img_format<span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">get_img_format</span><span class="p">(</span>filename<span class="p">)</span>
<span class="w">    </span><span class="c">% helper functgion to detect image format based on filename.</span>
<span class="w">    </span><span class="c">% uses &#39;get_supported_image_formats&#39;.</span>
<span class="w">    </span><span class="n">img_formats</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">get_supported_image_formats</span><span class="p">();</span>

<span class="w">    </span><span class="n">fns</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">fieldnames</span><span class="p">(</span><span class="n">img_formats</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="nb">numel</span><span class="p">(</span><span class="n">fns</span><span class="p">)</span>
<span class="w">        </span><span class="n">fn</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">fns</span><span class="p">{</span><span class="n">k</span><span class="p">};</span>

<span class="w">        </span><span class="n">img_spec</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">img_formats</span><span class="p">.(</span><span class="n">fn</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">img_spec</span><span class="p">.</span><span class="n">file_matcher</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
<span class="w">            </span><span class="n">img_format</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">fn</span><span class="p">;</span>
<span class="w">            </span><span class="k">return</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="nb">error</span><span class="p">(</span><span class="s">&#39;Unknown image format&#39;</span><span class="p">);</span>

<span class="k">function</span><span class="w"> </span>img_formats<span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">get_supported_image_formats</span><span class="p">()</span>
<span class="w">    </span><span class="c">% helper function to return the image format based on the filename</span>
<span class="w">    </span><span class="n">img_formats</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">struct</span><span class="p">();</span>

<span class="w">    </span><span class="c">% helper function to see if a filename ends with a certain string.</span>
<span class="w">    </span><span class="c">% uses currying - who doesn&#39;t like curry?</span>
<span class="w">    </span><span class="n">ends_with</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">@(</span><span class="n">ext</span><span class="p">)</span><span class="w"> </span><span class="p">@(</span><span class="n">fn</span><span class="p">)</span><span class="w"> </span><span class="nb">ischar</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="k">...</span>
<span class="w">                        </span><span class="nb">isempty</span><span class="p">(</span><span class="n">cosmo_strsplit</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="w"> </span><span class="n">ext</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>
<span class="w">    </span><span class="n">ends_with_any</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">@(</span><span class="n">exts</span><span class="p">)</span><span class="w"> </span><span class="p">@(</span><span class="n">fn</span><span class="p">)</span><span class="w"> </span><span class="nb">ischar</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">any</span><span class="p">(</span><span class="w"> </span><span class="k">...</span>
<span class="w">                                                    </span><span class="nb">cellfun</span><span class="p">(@(</span><span class="n">x</span><span class="p">)</span><span class="nb">isempty</span><span class="p">(</span><span class="w"> </span><span class="k">...</span>
<span class="w">                                                                        </span><span class="n">cosmo_strsplit</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span><span class="w"> </span><span class="n">exts</span><span class="p">));</span>

<span class="w">    </span><span class="c">% eeglab txt files</span>
<span class="w">    </span><span class="n">img_formats</span><span class="p">.</span><span class="n">eeglab_txt</span><span class="p">.</span><span class="n">file_matcher</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">ends_with</span><span class="p">(</span><span class="s">&#39;.txt&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="n">img_formats</span><span class="p">.</span><span class="n">eeglab_txt</span><span class="p">.</span><span class="n">reader</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">@</span><span class="n">read_eeglab_txt</span><span class="p">;</span>
<span class="w">    </span><span class="n">img_formats</span><span class="p">.</span><span class="n">eeglab_txt</span><span class="p">.</span><span class="n">externals</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{};</span>

<span class="w">    </span><span class="n">img_formats</span><span class="p">.</span><span class="n">eeglab</span><span class="p">.</span><span class="n">file_matcher</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">ends_with_any</span><span class="p">({</span><span class="s">&#39;.daterp&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                                                     </span><span class="s">&#39;.icaerp&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                                                     </span><span class="s">&#39;.dattimef&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                                                     </span><span class="s">&#39;.icatimef&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                                                     </span><span class="s">&#39;.datitc&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                                                     </span><span class="s">&#39;.icaitc&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                                                     </span><span class="s">&#39;.datersp&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                                                     </span><span class="s">&#39;.icaersp&#39;</span><span class="p">});</span>
<span class="w">    </span><span class="n">img_formats</span><span class="p">.</span><span class="n">eeglab</span><span class="p">.</span><span class="n">reader</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">@</span><span class="n">read_eeglab</span><span class="p">;</span>
<span class="w">    </span><span class="n">img_formats</span><span class="p">.</span><span class="n">eeglab</span><span class="p">.</span><span class="n">externals</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{};</span>

<span class="w">    </span><span class="n">img_formats</span><span class="p">.</span><span class="n">eeglab_struct</span><span class="p">.</span><span class="n">file_matcher</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">@</span><span class="n">is_eeglab_struct</span><span class="p">;</span>
<span class="w">    </span><span class="n">img_formats</span><span class="p">.</span><span class="n">eeglab_struct</span><span class="p">.</span><span class="n">reader</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">@</span><span class="n">convert_eeglab_struct</span><span class="p">;</span>
<span class="w">    </span><span class="n">img_formats</span><span class="p">.</span><span class="n">eeglab_struct</span><span class="p">.</span><span class="n">externals</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{};</span>

<span class="w">    </span><span class="c">% fieldtrip</span>
<span class="w">    </span><span class="c">% XXX any .mat file is currently assumed to be a fieldtrip struct</span>
<span class="w">    </span><span class="n">img_formats</span><span class="p">.</span><span class="n">ft</span><span class="p">.</span><span class="n">file_matcher</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">ends_with</span><span class="p">(</span><span class="s">&#39;.mat&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="n">img_formats</span><span class="p">.</span><span class="n">ft</span><span class="p">.</span><span class="n">reader</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">@</span><span class="n">read_ft</span><span class="p">;</span>
<span class="w">    </span><span class="n">img_formats</span><span class="p">.</span><span class="n">ft</span><span class="p">.</span><span class="n">externals</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{};</span>

<span class="w">    </span><span class="c">% fieldtrip matlab struct</span>
<span class="w">    </span><span class="n">img_formats</span><span class="p">.</span><span class="n">ft_struct</span><span class="p">.</span><span class="n">file_matcher</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">@(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="n">is_ft_struct</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
<span class="w">    </span><span class="n">img_formats</span><span class="p">.</span><span class="n">ft_struct</span><span class="p">.</span><span class="n">reader</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">@</span><span class="n">convert_ft</span><span class="p">;</span>
<span class="w">    </span><span class="n">img_formats</span><span class="p">.</span><span class="n">ft_struct</span><span class="p">.</span><span class="n">externals</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{};</span>

<span class="k">function</span><span class="w"> </span>ds<span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">posthoc_slice_dataset_if_necessary</span><span class="p">(</span>ds, opt<span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">~</span><span class="nb">isfield</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;trials&#39;</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="n">trial_idx</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">opt</span><span class="p">.</span><span class="n">trials</span><span class="p">;</span>
<span class="w">    </span><span class="n">verify_trial_params</span><span class="p">(</span><span class="nb">size</span><span class="p">(</span><span class="n">ds</span><span class="p">.</span><span class="n">samples</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">trial_idx</span><span class="p">);</span>
<span class="w">    </span><span class="n">ds</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">cosmo_slice</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">trial_idx</span><span class="p">);</span>

<span class="k">function</span><span class="w"> </span><span class="nf">verify_trial_params</span><span class="p">(</span>nsamples, trial_idx<span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">~</span><span class="nb">isnumeric</span><span class="p">(</span><span class="n">trial_idx</span><span class="p">)</span>
<span class="w">        </span><span class="nb">error</span><span class="p">(</span><span class="s">&#39;.trials option must be numeric&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="n">bad_msk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">trial_idx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">...</span>
<span class="w">                </span><span class="n">trial_idx</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">nsamples</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">...</span>
<span class="w">                </span><span class="nb">round</span><span class="p">(</span><span class="n">trial_idx</span><span class="p">)</span><span class="w"> </span><span class="o">~=</span><span class="w"> </span><span class="n">trial_idx</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">any</span><span class="p">(</span><span class="n">bad_msk</span><span class="p">)</span>
<span class="w">        </span><span class="n">bad_pos</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">find</span><span class="p">(</span><span class="n">bad_msk</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="nb">error</span><span class="p">([</span><span class="s">&#39;.trials option has illegal value at position %d; &#39;</span><span class="k">...</span>
<span class="w">               </span><span class="s">&#39;all values must be in (1:%d)&#39;</span><span class="p">],</span><span class="w"> </span><span class="k">...</span>
<span class="w">              </span><span class="n">bad_pos</span><span class="p">,</span><span class="w"> </span><span class="n">nsamples</span><span class="p">);</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="c">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="w">    </span><span class="c">% fieldtrip helper function</span>
<span class="w">    </span><span class="c">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="k">function</span><span class="w"> </span>ds<span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">read_ft</span><span class="p">(</span>filename, opt<span class="p">)</span>
<span class="w">    </span><span class="c">% reads it from a .mat data file</span>
<span class="w">    </span><span class="n">ft</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">importdata</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
<span class="w">    </span><span class="n">ds</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">convert_ft</span><span class="p">(</span><span class="n">ft</span><span class="p">,</span><span class="w"> </span><span class="n">opt</span><span class="p">);</span>

<span class="k">function</span><span class="w"> </span>ds<span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">convert_ft</span><span class="p">(</span>ft, opt<span class="p">)</span>
<span class="w">    </span><span class="p">[</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">samples_field</span><span class="p">,</span><span class="w"> </span><span class="n">fdim</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">get_ft_data</span><span class="p">(</span><span class="n">ft</span><span class="p">,</span><span class="w"> </span><span class="n">opt</span><span class="p">);</span>

<span class="w">    </span><span class="n">ds</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">cosmo_flatten</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">fdim</span><span class="p">.</span><span class="n">labels</span><span class="p">,</span><span class="w"> </span><span class="n">fdim</span><span class="p">.</span><span class="n">values</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                       </span><span class="s">&#39;matrix_labels&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">get_ft_matrix_labels</span><span class="p">());</span>
<span class="w">    </span><span class="n">ds</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">meeg</span><span class="p">.</span><span class="n">samples_field</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">samples_field</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">is_ft_source_struct</span><span class="p">(</span><span class="n">ft</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nb">isfield</span><span class="p">(</span><span class="n">ft</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;inside&#39;</span><span class="p">)</span>
<span class="w">            </span><span class="n">ds</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">apply_ft_source_inside</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">fdim</span><span class="p">.</span><span class="n">labels</span><span class="p">,</span><span class="w"> </span><span class="n">fdim</span><span class="p">.</span><span class="n">values</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                                        </span><span class="n">ft</span><span class="p">.</span><span class="n">inside</span><span class="p">);</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="n">optional_fields</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="s">&#39;dim&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;tri&#39;</span><span class="p">};</span>
<span class="w">        </span><span class="n">ds</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">meeg</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">copy_optional_fields</span><span class="p">(</span><span class="n">ds</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">meeg</span><span class="p">,</span><span class="w"> </span><span class="n">ft</span><span class="p">,</span><span class="w"> </span><span class="n">optional_fields</span><span class="p">);</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="n">ds</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">meeg</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">set_samples_label_explicitly_if_necessary</span><span class="p">(</span><span class="n">ds</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">meeg</span><span class="p">,</span><span class="w"> </span><span class="n">ft</span><span class="p">);</span>

<span class="w">    </span><span class="n">nsamples</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">size</span><span class="p">(</span><span class="n">ds</span><span class="p">.</span><span class="n">samples</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="n">ft_fields</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="s">&#39;rpt&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;trialinfo&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;cumtapcnt&#39;</span><span class="p">};</span>
<span class="w">    </span><span class="n">ds</span><span class="p">.</span><span class="n">sa</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">copy_fields_for_matching_sample_size</span><span class="p">(</span><span class="n">ft</span><span class="p">,</span><span class="w"> </span><span class="n">nsamples</span><span class="p">,</span><span class="w"> </span><span class="n">ft_fields</span><span class="p">);</span>

<span class="w">    </span><span class="n">ds</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">posthoc_slice_dataset_if_necessary</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">opt</span><span class="p">);</span>

<span class="k">function</span><span class="w"> </span>s<span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">copy_optional_fields</span><span class="p">(</span>s, source, optional_fields<span class="p">)</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="nb">numel</span><span class="p">(</span><span class="n">optional_fields</span><span class="p">)</span>
<span class="w">        </span><span class="n">key</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">optional_fields</span><span class="p">{</span><span class="n">k</span><span class="p">};</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nb">isfield</span><span class="p">(</span><span class="n">source</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">)</span>
<span class="w">            </span><span class="n">s</span><span class="p">.(</span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">source</span><span class="p">.(</span><span class="n">key</span><span class="p">);</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>

<span class="k">function</span><span class="w"> </span>a_meeg<span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">set_samples_label_explicitly_if_necessary</span><span class="p">(</span>a_meeg, ft<span class="p">)</span>
<span class="w">    </span><span class="c">% deal with grand average data</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">~</span><span class="n">cosmo_isfield</span><span class="p">(</span><span class="n">ft</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;dimord&#39;</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="n">first_label</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">cosmo_strsplit</span><span class="p">(</span><span class="n">ft</span><span class="p">.</span><span class="n">dimord</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;_&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">cosmo_match</span><span class="p">({</span><span class="n">first_label</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="s">&#39;subj&#39;</span><span class="p">})</span>
<span class="w">        </span><span class="n">a_meeg</span><span class="p">.</span><span class="n">samples_label</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">first_label</span><span class="p">;</span>
<span class="w">    </span><span class="k">end</span>

<span class="k">function</span><span class="w"> </span><span class="nf">[data, samples_field, fdim] = get_ft_data</span><span class="p">(</span>ft, opt<span class="p">)</span>
<span class="w">    </span><span class="p">[</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">samples_field</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">get_data_ft</span><span class="p">(</span><span class="n">ft</span><span class="p">,</span><span class="w"> </span><span class="n">opt</span><span class="p">);</span>
<span class="w">    </span><span class="p">[</span><span class="n">dim_labels</span><span class="p">,</span><span class="w"> </span><span class="n">ft_dim_labels</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">get_ft_dim_labels</span><span class="p">(</span><span class="n">ft</span><span class="p">,</span><span class="w"> </span><span class="n">samples_field</span><span class="p">);</span>

<span class="w">    </span><span class="n">nlabels</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">numel</span><span class="p">(</span><span class="n">dim_labels</span><span class="p">);</span>
<span class="w">    </span><span class="n">dim_values</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">cell</span><span class="p">(</span><span class="n">nlabels</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="n">matrix_labels</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">get_ft_matrix_labels</span><span class="p">();</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">nlabels</span>
<span class="w">        </span><span class="n">label</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">ft_dim_labels</span><span class="p">{</span><span class="n">k</span><span class="p">};</span>
<span class="w">        </span><span class="n">value</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">ft</span><span class="p">.(</span><span class="n">label</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">cosmo_match</span><span class="p">({</span><span class="n">label</span><span class="p">},</span><span class="w"> </span><span class="n">matrix_labels</span><span class="p">)</span>
<span class="w">            </span><span class="n">dim_values</span><span class="p">{</span><span class="n">k</span><span class="p">}</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">value</span><span class="o">&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span><span class="n">dim_values</span><span class="p">{</span><span class="n">k</span><span class="p">}</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">value</span><span class="p">(:)</span><span class="o">&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="n">fdim</span><span class="p">.</span><span class="n">labels</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">dim_labels</span><span class="p">;</span>
<span class="w">    </span><span class="n">fdim</span><span class="p">.</span><span class="n">values</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">dim_values</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">is_ft_source_struct</span><span class="p">(</span><span class="n">ft</span><span class="p">)</span>
<span class="w">        </span><span class="n">fdim</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">add_ft_mom_field_if_present</span><span class="p">(</span><span class="n">fdim</span><span class="p">,</span><span class="w"> </span><span class="n">samples_field</span><span class="p">,</span><span class="w"> </span><span class="nb">size</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
<span class="w">        </span><span class="p">[</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">fdim</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">fix_ft_lcmv_if_necessary</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">fdim</span><span class="p">);</span>
<span class="w">    </span><span class="k">end</span>

<span class="k">function</span><span class="w"> </span><span class="nf">[data, fdim] = fix_ft_lcmv_if_necessary</span><span class="p">(</span>data, fdim<span class="p">)</span>
<span class="w">    </span><span class="c">% FT LCMV does something weird for average data; the .avg.pow field</span>
<span class="w">    </span><span class="c">% is 1xNCHAN for a NCHAN x NTIME field.</span>
<span class="w">    </span><span class="c">% To address this:</span>
<span class="w">    </span><span class="c">% - reshape the data</span>
<span class="w">    </span><span class="c">% - average the time field</span>
<span class="w">    </span><span class="n">dim_labels</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">fdim</span><span class="p">.</span><span class="n">labels</span><span class="p">;</span>
<span class="w">    </span><span class="n">data_size</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">size</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

<span class="w">    </span><span class="n">pos_pos</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">find</span><span class="p">(</span><span class="n">cosmo_match</span><span class="p">(</span><span class="n">dim_labels</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;pos&#39;</span><span class="p">));</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">~</span><span class="nb">isempty</span><span class="p">(</span><span class="n">pos_pos</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="k">...</span><span class="c"> % has pos field</span>
<span class="w">                </span><span class="n">pos_pos</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nb">numel</span><span class="p">(</span><span class="n">dim_labels</span><span class="p">)</span>

<span class="w">        </span><span class="n">npos</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">size</span><span class="p">(</span><span class="n">fdim</span><span class="p">.</span><span class="n">values</span><span class="p">{</span><span class="n">pos_pos</span><span class="p">},</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="w">        </span><span class="n">next_dim_pos</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">pos_pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">data_size</span><span class="p">(</span><span class="n">pos_pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">data_size</span><span class="p">(</span><span class="n">next_dim_pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">npos</span>
<span class="w">            </span><span class="n">new_data_size</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">data_size</span><span class="p">;</span>

<span class="w">            </span><span class="c">% fix with next dimension</span>
<span class="w">            </span><span class="n">new_data_size</span><span class="p">(</span><span class="n">pos_pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">npos</span><span class="p">;</span>
<span class="w">            </span><span class="n">new_data_size</span><span class="p">(</span><span class="n">next_dim_pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">            </span><span class="n">data</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">reshape</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">new_data_size</span><span class="p">);</span>

<span class="w">            </span><span class="c">% the next dimension (typically time) is averaged if</span>
<span class="w">            </span><span class="c">% necessary</span>
<span class="w">            </span><span class="n">next_dim_value</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">fdim</span><span class="p">.</span><span class="n">values</span><span class="p">{</span><span class="n">next_dim_pos</span><span class="p">};</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nb">numel</span><span class="p">(</span><span class="n">next_dim_value</span><span class="p">)</span><span class="w"> </span><span class="o">~=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">                </span><span class="n">fdim</span><span class="p">.</span><span class="n">values</span><span class="p">{</span><span class="n">next_dim_pos</span><span class="p">}</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">mean</span><span class="p">(</span><span class="n">next_dim_value</span><span class="p">);</span>
<span class="w">            </span><span class="k">end</span>

<span class="w">        </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>

<span class="k">function</span><span class="w"> </span>fdim<span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">add_ft_mom_field_if_present</span><span class="p">(</span>fdim, samples_field, size_data<span class="p">)</span>
<span class="w">    </span><span class="c">% insert .mom field for source struct</span>
<span class="w">    </span><span class="n">samples_field_split</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">cosmo_strsplit</span><span class="p">(</span><span class="n">samples_field</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;.&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="n">has_mom</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">numel</span><span class="p">(</span><span class="n">samples_field_split</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="k">...</span>
<span class="w">                    </span><span class="nb">strcmp</span><span class="p">(</span><span class="n">samples_field_split</span><span class="p">{</span><span class="mi">2</span><span class="p">},</span><span class="w"> </span><span class="s">&#39;mom&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">has_mom</span>
<span class="w">        </span><span class="n">ndim</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">size_data</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<span class="w">        </span><span class="n">fdim</span><span class="p">.</span><span class="n">labels</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="n">fdim</span><span class="p">.</span><span class="n">labels</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="k">...</span>
<span class="w">                       </span><span class="p">{</span><span class="s">&#39;mom&#39;</span><span class="p">};</span><span class="w"> </span><span class="k">...</span>
<span class="w">                       </span><span class="n">fdim</span><span class="p">.</span><span class="n">labels</span><span class="p">(</span><span class="mi">2</span><span class="p">:</span><span class="k">end</span><span class="p">)];</span>
<span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="n">ndim</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span>
<span class="w">                </span><span class="nb">values</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="s">&#39;xyz&#39;</span><span class="p">};</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="mi">3</span>
<span class="w">                </span><span class="nb">values</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="s">&#39;x&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;y&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;z&#39;</span><span class="p">};</span>
<span class="w">            </span><span class="k">otherwise</span>
<span class="w">                </span><span class="nb">error</span><span class="p">(</span><span class="s">&#39;Unsupported number of dimensions for %s: %d&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                      </span><span class="n">samples_field</span><span class="p">,</span><span class="w"> </span><span class="n">ndim</span><span class="p">);</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">        </span><span class="n">fdim</span><span class="p">.</span><span class="n">values</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="n">fdim</span><span class="p">.</span><span class="n">values</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="k">...</span>
<span class="w">                       </span><span class="p">{</span><span class="nb">values</span><span class="p">};</span><span class="w"> </span><span class="k">...</span>
<span class="w">                       </span><span class="n">fdim</span><span class="p">.</span><span class="n">values</span><span class="p">(</span><span class="mi">2</span><span class="p">:</span><span class="k">end</span><span class="p">)];</span>
<span class="w">    </span><span class="k">end</span>

<span class="k">function</span><span class="w"> </span>labels<span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">get_ft_matrix_labels</span><span class="p">()</span>
<span class="w">    </span><span class="n">labels</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="s">&#39;pos&#39;</span><span class="p">};</span>

<span class="k">function</span><span class="err"> [</span><span class="nf">cosmo_dim_labels</span><span class="p">,</span><span class="w"> </span><span class="n">ft_dim_labels</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">get_ft_dim_labels</span><span class="p">(</span><span class="n">ft</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                                                               </span><span class="n">samples_field</span><span class="p">)</span>
<span class="w">    </span><span class="n">cosmo_ft_dim_labels</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s">&#39;pos&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;pos&#39;</span><span class="p">;</span><span class="w"> </span><span class="k">...</span>
<span class="w">                           </span><span class="s">&#39;chan&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;label&#39;</span><span class="p">;</span><span class="w"> </span><span class="k">...</span>
<span class="w">                           </span><span class="s">&#39;freq&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;freq&#39;</span><span class="p">;</span><span class="w"> </span><span class="k">...</span>
<span class="w">                           </span><span class="s">&#39;time&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;time&#39;</span><span class="p">};</span>

<span class="w">    </span><span class="n">is_source</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">is_ft_source_struct</span><span class="p">(</span><span class="n">ft</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">is_source</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">isfield</span><span class="p">(</span><span class="n">ft</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;dimord&#39;</span><span class="p">)</span>
<span class="w">        </span><span class="nb">error</span><span class="p">(</span><span class="s">&#39;Weird fieldtrip data: .pos and .dimord are not compatible&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">is_source</span>
<span class="w">        </span><span class="c">% source data</span>
<span class="w">        </span><span class="nb">keys</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">fieldnames</span><span class="p">(</span><span class="n">ft</span><span class="p">);</span>
<span class="w">        </span><span class="n">labels_msk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">cosmo_match</span><span class="p">(</span><span class="n">cosmo_ft_dim_labels</span><span class="p">(:,</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="nb">keys</span><span class="p">);</span>
<span class="w">    </span><span class="k">else</span>

<span class="w">        </span><span class="n">dimord_labels</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">cosmo_strsplit</span><span class="p">(</span><span class="n">ft</span><span class="p">.</span><span class="n">dimord</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;_&#39;</span><span class="p">);</span>

<span class="w">        </span><span class="n">sample_field</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">get_sample_dimord_field</span><span class="p">(</span><span class="n">ft</span><span class="p">);</span>
<span class="w">        </span><span class="n">sample_msk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">cosmo_match</span><span class="p">(</span><span class="n">dimord_labels</span><span class="p">,</span><span class="w"> </span><span class="n">sample_field</span><span class="p">);</span>

<span class="w">        </span><span class="n">dimord_labels_without_sample</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">dimord_labels</span><span class="p">(</span><span class="o">~</span><span class="n">sample_msk</span><span class="p">);</span>

<span class="w">        </span><span class="n">labels_msk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">cosmo_match</span><span class="p">(</span><span class="n">cosmo_ft_dim_labels</span><span class="p">(:,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="k">...</span>
<span class="w">                                 </span><span class="n">dimord_labels_without_sample</span><span class="p">);</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="n">ft_dim_labels</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">cosmo_ft_dim_labels</span><span class="p">(</span><span class="n">labels_msk</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="w">    </span><span class="n">cosmo_dim_labels</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">cosmo_ft_dim_labels</span><span class="p">(</span><span class="n">labels_msk</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>

<span class="k">function</span><span class="w"> </span>sample_field<span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">get_sample_dimord_field</span><span class="p">(</span>ft<span class="p">)</span>
<span class="w">    </span><span class="n">sample_field</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;&#39;</span><span class="p">;</span>

<span class="w">    </span><span class="n">sample_dimord_fields</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="s">&#39;rpt&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;trial&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;subj&#39;</span><span class="p">};</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">isfield</span><span class="p">(</span><span class="n">ft</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;dimord&#39;</span><span class="p">)</span>
<span class="w">        </span><span class="n">ft_dimord_fields</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">cosmo_strsplit</span><span class="p">(</span><span class="n">ft</span><span class="p">.</span><span class="n">dimord</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;_&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="n">msk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">cosmo_match</span><span class="p">(</span><span class="n">ft_dimord_fields</span><span class="p">,</span><span class="w"> </span><span class="n">sample_dimord_fields</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nb">any</span><span class="p">(</span><span class="n">msk</span><span class="p">)</span>
<span class="w">            </span><span class="nb">assert</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">msk</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">            </span><span class="n">sample_field</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">sample_dimord_fields</span><span class="p">{</span><span class="n">msk</span><span class="p">};</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>

<span class="k">function</span><span class="w"> </span>sa<span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">copy_fields_for_matching_sample_size</span><span class="p">(</span>ft, nsamples, keys<span class="p">)</span>
<span class="w">    </span><span class="n">n</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">numel</span><span class="p">(</span><span class="nb">keys</span><span class="p">);</span>

<span class="w">    </span><span class="n">sa</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">struct</span><span class="p">();</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">n</span>
<span class="w">        </span><span class="n">key</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">keys</span><span class="p">{</span><span class="n">k</span><span class="p">};</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nb">isfield</span><span class="p">(</span><span class="n">ft</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">)</span>
<span class="w">            </span><span class="n">value</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">ft</span><span class="p">.(</span><span class="n">key</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nb">size</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">nsamples</span>
<span class="w">                </span><span class="n">sa</span><span class="p">.(</span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>
<span class="w">            </span><span class="k">end</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>

<span class="k">function</span><span class="w"> </span>ds<span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">apply_ft_source_inside</span><span class="p">(</span>ds, dim_labels, dim_values, ft_inside<span class="p">)</span>
<span class="w">    </span><span class="n">ndim</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">numel</span><span class="p">(</span><span class="n">dim_labels</span><span class="p">);</span>
<span class="w">    </span><span class="n">dim_sizes</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">cellfun</span><span class="p">(@</span><span class="nb">numel</span><span class="p">,</span><span class="w"> </span><span class="n">dim_values</span><span class="p">);</span>

<span class="w">    </span><span class="n">pos_idx</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">find</span><span class="p">(</span><span class="n">cosmo_match</span><span class="p">(</span><span class="n">dim_labels</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;pos&#39;</span><span class="p">),</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="nb">assert</span><span class="p">(</span><span class="o">~</span><span class="nb">isempty</span><span class="p">(</span><span class="n">pos_idx</span><span class="p">),</span><span class="w"> </span><span class="p">[</span><span class="s">&#39;this function should only be called &#39;</span><span class="k">...</span>
<span class="w">                               </span><span class="s">&#39;with source datasets&#39;</span><span class="p">]);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">isnumeric</span><span class="p">(</span><span class="n">ft_inside</span><span class="p">)</span>
<span class="w">        </span><span class="n">pos</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">ds</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">fdim</span><span class="p">.</span><span class="n">values</span><span class="p">{</span><span class="n">pos_idx</span><span class="p">};</span>
<span class="w">        </span><span class="p">[</span><span class="n">three</span><span class="p">,</span><span class="w"> </span><span class="n">npos</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">size</span><span class="p">(</span><span class="n">pos</span><span class="p">);</span>
<span class="w">        </span><span class="nb">assert</span><span class="p">(</span><span class="n">three</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span>
<span class="w">        </span><span class="n">inside_mask</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">false</span><span class="p">(</span><span class="n">npos</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">inside_mask</span><span class="p">(</span><span class="n">ft_inside</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">    </span><span class="k">elseif</span><span class="w"> </span><span class="nb">islogical</span><span class="p">(</span><span class="n">ft_inside</span><span class="p">)</span>
<span class="w">        </span><span class="n">inside_mask</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">ft_inside</span><span class="p">;</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="nb">error</span><span class="p">(</span><span class="s">&#39;.inside must either be numeric or logical&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="n">inside_vec_size</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="nb">ones</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ndim</span><span class="p">)];</span>
<span class="w">    </span><span class="n">inside_vec_size</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pos_idx</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">numel</span><span class="p">(</span><span class="n">inside_mask</span><span class="p">);</span>
<span class="w">    </span><span class="n">inside_array_vec</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">reshape</span><span class="p">(</span><span class="n">inside_mask</span><span class="p">,</span><span class="w"> </span><span class="n">inside_vec_size</span><span class="p">);</span>

<span class="w">    </span><span class="n">other_dim_size</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="n">dim_sizes</span><span class="p">(:)</span><span class="o">&#39;</span><span class="p">];</span>
<span class="w">    </span><span class="n">other_dim_size</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pos_idx</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">    </span><span class="n">inside_array</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">repmat</span><span class="p">(</span><span class="n">inside_array_vec</span><span class="p">,</span><span class="w"> </span><span class="n">other_dim_size</span><span class="p">);</span>
<span class="w">    </span><span class="n">inside_ds</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">cosmo_flatten</span><span class="p">(</span><span class="n">inside_array</span><span class="p">,</span><span class="w"> </span><span class="n">dim_labels</span><span class="p">,</span><span class="w"> </span><span class="n">dim_values</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                              </span><span class="s">&#39;matrix_labels&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s">&#39;pos&#39;</span><span class="p">});</span>
<span class="w">    </span><span class="n">ds</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">cosmo_slice</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">inside_ds</span><span class="p">.</span><span class="n">samples</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>

<span class="k">function</span><span class="w"> </span><span class="nf">[data, sample_field] = get_data_ft</span><span class="p">(</span>ft, opt<span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">is_ft_source_struct</span><span class="p">(</span><span class="n">ft</span><span class="p">)</span>
<span class="w">        </span><span class="p">[</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">sample_field</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">get_source_data_ft</span><span class="p">(</span><span class="n">ft</span><span class="p">,</span><span class="w"> </span><span class="n">opt</span><span class="p">);</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="p">[</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">sample_field</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">get_sensor_data_ft</span><span class="p">(</span><span class="n">ft</span><span class="p">);</span>
<span class="w">    </span><span class="k">end</span>

<span class="k">function</span><span class="w"> </span><span class="nf">[data, sample_field] = get_source_data_ft</span><span class="p">(</span>ft, opt<span class="p">)</span>
<span class="w">    </span><span class="n">main_fields</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="s">&#39;trial&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;avg&#39;</span><span class="p">};</span>
<span class="w">    </span><span class="n">sub_fields</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="s">&#39;pow&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;mom&#39;</span><span class="p">};</span>

<span class="w">    </span><span class="n">msk_main</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">cosmo_match</span><span class="p">(</span><span class="n">main_fields</span><span class="p">,</span><span class="w"> </span><span class="nb">fieldnames</span><span class="p">(</span><span class="n">ft</span><span class="p">));</span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="nb">sum</span><span class="p">(</span><span class="n">msk_main</span><span class="p">)</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">0</span>
<span class="w">            </span><span class="nb">error</span><span class="p">(</span><span class="s">&#39;No data found in source struct&#39;</span><span class="p">);</span>

<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span>
<span class="w">            </span><span class="c">% ok</span>

<span class="w">        </span><span class="k">otherwise</span>
<span class="w">            </span><span class="nb">error</span><span class="p">(</span><span class="s">&#39;Multiple data fields found in source struct&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="n">main_field</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">main_fields</span><span class="p">{</span><span class="n">msk_main</span><span class="p">};</span>
<span class="w">    </span><span class="n">main_data</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">ft</span><span class="p">.(</span><span class="n">main_field</span><span class="p">);</span>

<span class="w">    </span><span class="n">sub_field_option</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;data_field&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">isfield</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="w"> </span><span class="n">sub_field_option</span><span class="p">)</span>
<span class="w">        </span><span class="n">sub_field</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">opt</span><span class="p">.(</span><span class="n">sub_field_option</span><span class="p">);</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="n">msk_sub</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">cosmo_match</span><span class="p">(</span><span class="n">sub_fields</span><span class="p">,</span><span class="w"> </span><span class="nb">fieldnames</span><span class="p">(</span><span class="n">main_data</span><span class="p">));</span>

<span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="nb">sum</span><span class="p">(</span><span class="n">msk_sub</span><span class="p">)</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="mi">0</span>
<span class="w">                </span><span class="nb">error</span><span class="p">(</span><span class="s">&#39;No data found in .%s source struct&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">main_field</span><span class="p">);</span>

<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span>
<span class="w">                </span><span class="n">sub_field</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">sub_fields</span><span class="p">{</span><span class="n">msk_sub</span><span class="p">};</span>

<span class="w">            </span><span class="k">otherwise</span>
<span class="w">                </span><span class="nb">error</span><span class="p">([</span><span class="s">&#39;Multiple data fields found in .%s source &#39;</span><span class="k">...</span>
<span class="w">                       </span><span class="s">&#39;struct: &#39;&#39;%s&#39;&#39;. To select one of these, use &#39;</span><span class="k">...</span>
<span class="w">                       </span><span class="s">&#39;the &#39;&#39;%s&#39;&#39; option&#39;</span><span class="p">],</span><span class="w"> </span><span class="k">...</span>
<span class="w">                      </span><span class="n">main_field</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                      </span><span class="n">cosmo_strjoin</span><span class="p">(</span><span class="n">sub_fields</span><span class="p">(</span><span class="n">msk_sub</span><span class="p">),</span><span class="w"> </span><span class="s">&#39;&#39;&#39;, &#39;&#39;&#39;</span><span class="p">),</span><span class="w"> </span><span class="k">...</span>
<span class="w">                      </span><span class="n">sub_field_option</span><span class="p">);</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="n">data</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">extract_source_data_array_ft</span><span class="p">(</span><span class="n">main_data</span><span class="p">,</span><span class="w"> </span><span class="n">sub_field</span><span class="p">);</span>
<span class="w">    </span><span class="n">sample_field</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">sprintf</span><span class="p">(</span><span class="s">&#39;%s.%s&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">main_field</span><span class="p">,</span><span class="w"> </span><span class="n">sub_field</span><span class="p">);</span>

<span class="k">function</span><span class="w"> </span>data<span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">extract_source_data_array_ft</span><span class="p">(</span>main_data, sub_field<span class="p">)</span>
<span class="w">    </span><span class="n">nsamples</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">numel</span><span class="p">(</span><span class="n">main_data</span><span class="p">);</span>
<span class="w">    </span><span class="n">first_data</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">main_data</span><span class="p">(</span><span class="mi">1</span><span class="p">).(</span><span class="n">sub_field</span><span class="p">);</span>
<span class="w">    </span><span class="n">data_cell</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">cell</span><span class="p">(</span><span class="n">nsamples</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>

<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="n">sub_field</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="s">&#39;mom&#39;</span>
<span class="w">            </span><span class="n">npos</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">numel</span><span class="p">(</span><span class="n">first_data</span><span class="p">);</span>
<span class="w">            </span><span class="n">data_inside_pos</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">find</span><span class="p">(</span><span class="o">~</span><span class="nb">cellfun</span><span class="p">(@</span><span class="nb">isempty</span><span class="p">,</span><span class="w"> </span><span class="n">first_data</span><span class="p">));</span>
<span class="w">            </span><span class="n">ninside</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">numel</span><span class="p">(</span><span class="n">data_inside_pos</span><span class="p">);</span>

<span class="w">            </span><span class="p">[</span><span class="n">nmom</span><span class="p">,</span><span class="w"> </span><span class="n">nfeatures</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">size</span><span class="p">(</span><span class="n">first_data</span><span class="p">{</span><span class="n">data_inside_pos</span><span class="p">(</span><span class="mi">1</span><span class="p">)});</span>

<span class="w">            </span><span class="n">data_arr_empty</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">NaN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">npos</span><span class="p">,</span><span class="w"> </span><span class="n">nmom</span><span class="p">,</span><span class="w"> </span><span class="n">nfeatures</span><span class="p">);</span>

<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="nb">j</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">nsamples</span>
<span class="w">                </span><span class="n">data_cell_cell</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">main_data</span><span class="p">(</span><span class="nb">j</span><span class="p">).(</span><span class="n">sub_field</span><span class="p">);</span>
<span class="w">                </span><span class="n">data_arr</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">data_arr_empty</span><span class="p">;</span>

<span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">ninside</span>
<span class="w">                    </span><span class="n">pos</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">data_inside_pos</span><span class="p">(</span><span class="n">k</span><span class="p">);</span>
<span class="w">                    </span><span class="n">data_arr</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="p">:,</span><span class="w"> </span><span class="p">:)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">data_cell_cell</span><span class="p">{</span><span class="n">pos</span><span class="p">};</span>
<span class="w">                </span><span class="k">end</span>

<span class="w">                </span><span class="n">data_cell</span><span class="p">{</span><span class="nb">j</span><span class="p">}</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">data_arr</span><span class="p">;</span>
<span class="w">            </span><span class="k">end</span>

<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="s">&#39;pow&#39;</span>
<span class="w">            </span><span class="n">feature_size</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">size</span><span class="p">(</span><span class="n">first_data</span><span class="p">);</span>

<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="nb">j</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">nsamples</span>
<span class="w">                </span><span class="n">data_arr</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">main_data</span><span class="p">(</span><span class="nb">j</span><span class="p">).(</span><span class="n">sub_field</span><span class="p">);</span>
<span class="w">                </span><span class="n">data_cell</span><span class="p">{</span><span class="nb">j</span><span class="p">}</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">reshape</span><span class="p">(</span><span class="n">data_arr</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="n">feature_size</span><span class="p">]);</span>
<span class="w">            </span><span class="k">end</span>

<span class="w">        </span><span class="k">otherwise</span>
<span class="w">            </span><span class="nb">error</span><span class="p">(</span><span class="s">&#39;not supported sub_field: %s&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">sub_field</span><span class="p">);</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="n">data</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">cat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">data_cell</span><span class="p">{:});</span>

<span class="k">function</span><span class="w"> </span><span class="nf">[data, sample_field] = get_sensor_data_ft</span><span class="p">(</span>ft<span class="p">)</span>
<span class="w">    </span><span class="c">% order precedence: if .trial and .avg both exist, take .trial</span>
<span class="w">    </span><span class="n">sample_fields_in_order</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="s">&#39;trial&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;individual&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                              </span><span class="s">&#39;fourierspctrm&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;powspctrm&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;avg&#39;</span><span class="p">};</span>
<span class="w">    </span><span class="n">msk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">cosmo_match</span><span class="p">(</span><span class="n">sample_fields_in_order</span><span class="p">,</span><span class="w"> </span><span class="nb">fieldnames</span><span class="p">(</span><span class="n">ft</span><span class="p">));</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">~</span><span class="nb">any</span><span class="p">(</span><span class="n">msk</span><span class="p">)</span>
<span class="w">        </span><span class="nb">error</span><span class="p">([</span><span class="s">&#39;No supported data field found in sensor data struct. &#39;</span><span class="k">...</span>
<span class="w">               </span><span class="s">&#39;If this data struct was generated by FieldTrip, &#39;</span><span class="k">...</span>
<span class="w">               </span><span class="s">&#39;consider contacting CoSMoMVPA&#39;&#39;s authors.&#39;</span><span class="p">]);</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="nb">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">find</span><span class="p">(</span><span class="n">msk</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="n">sample_field</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">sample_fields_in_order</span><span class="p">{</span><span class="nb">i</span><span class="p">};</span>

<span class="w">    </span><span class="n">data</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">ft</span><span class="p">.(</span><span class="n">sample_field</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">isempty</span><span class="p">(</span><span class="n">get_sample_dimord_field</span><span class="p">(</span><span class="n">ft</span><span class="p">))</span>
<span class="w">        </span><span class="c">% no &#39;rpt_...&#39; or &#39;subj_&#39;</span>
<span class="w">        </span><span class="n">data</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">reshape</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="nb">size</span><span class="p">(</span><span class="n">data</span><span class="p">)]);</span>
<span class="w">    </span><span class="k">end</span>

<span class="k">function</span><span class="w"> </span>tf<span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">is_ft_source_struct</span><span class="p">(</span>ft<span class="p">)</span>
<span class="w">    </span><span class="n">tf</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">isstruct</span><span class="p">(</span><span class="n">ft</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">isfield</span><span class="p">(</span><span class="n">ft</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;pos&#39;</span><span class="p">);</span>

<span class="k">function</span><span class="w"> </span>tf<span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">is_ft_sensor_struct</span><span class="p">(</span>ft<span class="p">)</span>
<span class="w">    </span><span class="n">tf</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">isfield</span><span class="p">(</span><span class="n">ft</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;dimord&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">isfield</span><span class="p">(</span><span class="n">ft</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;label&#39;</span><span class="p">);</span>

<span class="k">function</span><span class="w"> </span>tf<span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">is_ft_struct</span><span class="p">(</span>ft<span class="p">)</span>
<span class="w">    </span><span class="n">tf</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">is_ft_source_struct</span><span class="p">(</span><span class="n">ft</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">is_ft_sensor_struct</span><span class="p">(</span><span class="n">ft</span><span class="p">);</span>

<span class="w">    </span><span class="c">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="w">    </span><span class="c">% eeglab struct helper function</span>
<span class="w">    </span><span class="c">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="k">function</span><span class="w"> </span>tf<span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">is_eeglab_struct</span><span class="p">(</span>s<span class="p">)</span>
<span class="w">    </span><span class="n">tf</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">isstruct</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="k">...</span>
<span class="w">            </span><span class="nb">isfield</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;times&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="k">...</span>
<span class="w">            </span><span class="nb">isfield</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;datatype&#39;</span><span class="p">);</span>

<span class="k">function</span><span class="w"> </span>ds<span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">read_eeglab</span><span class="p">(</span>fn, opt<span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">isfield</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;trials&#39;</span><span class="p">)</span>
<span class="w">        </span><span class="c">% can have significant reduction in memory requirements</span>
<span class="w">        </span><span class="c">% at the expense of loading different parts of the same file</span>
<span class="w">        </span><span class="c">% multiple times.</span>
<span class="w">        </span><span class="n">s</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">eeglab_load_with_trials</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="w"> </span><span class="n">opt</span><span class="p">.</span><span class="n">trials</span><span class="p">);</span>
<span class="w">        </span><span class="n">opt</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">rmfield</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;trials&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="n">s</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">load</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;-mat&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="n">ds</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">convert_eeglab_struct</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">opt</span><span class="p">);</span>

<span class="k">function</span><span class="w"> </span>s<span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">eeglab_load_with_trials</span><span class="p">(</span>fn, trial_idx<span class="p">)</span>
<span class="w">    </span><span class="c">% can save memory by loaded each channel separately</span>
<span class="w">    </span><span class="n">s_minimal</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">load</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;-mat&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;datatype&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="n">has_freq</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">helper_eeglab_get_freq_info</span><span class="p">(</span><span class="n">s_minimal</span><span class="p">);</span>

<span class="w">    </span><span class="n">w</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">whos</span><span class="p">(</span><span class="s">&#39;-file&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">fn</span><span class="p">);</span>
<span class="w">    </span><span class="n">s_surrogate</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">struct</span><span class="p">();</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="nb">numel</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
<span class="w">        </span><span class="n">s_surrogate</span><span class="p">.(</span><span class="n">w</span><span class="p">(</span><span class="n">k</span><span class="p">).</span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="p">[</span><span class="n">chan_prefix</span><span class="p">,</span><span class="w"> </span><span class="n">chan_suffix</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">eeglab_get_chan_pre_suffix</span><span class="p">(</span><span class="n">s_surrogate</span><span class="p">);</span>
<span class="w">    </span><span class="p">[</span><span class="n">chan_labels</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">eeglab_get_chan_labels</span><span class="p">(</span><span class="n">s_surrogate</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                                           </span><span class="n">chan_prefix</span><span class="p">,</span><span class="w"> </span><span class="n">chan_suffix</span><span class="p">);</span>
<span class="w">    </span><span class="n">other_labels</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">setdiff</span><span class="p">({</span><span class="n">w</span><span class="p">.</span><span class="n">name</span><span class="p">},</span><span class="w"> </span><span class="n">chan_labels</span><span class="p">);</span>
<span class="w">    </span><span class="nb">assert</span><span class="p">(</span><span class="nb">numel</span><span class="p">(</span><span class="n">other_labels</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nb">numel</span><span class="p">(</span><span class="n">w</span><span class="p">));</span>

<span class="w">    </span><span class="n">s</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">load</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;-mat&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">other_labels</span><span class="p">{:});</span>
<span class="w">    </span><span class="n">n_chan</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">numel</span><span class="p">(</span><span class="n">chan_labels</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">n_chan</span>
<span class="w">        </span><span class="n">label</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">chan_labels</span><span class="p">{</span><span class="n">k</span><span class="p">};</span>
<span class="w">        </span><span class="n">data_struct</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">load</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;-mat&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">label</span><span class="p">);</span>
<span class="w">        </span><span class="n">data</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">data_struct</span><span class="p">.(</span><span class="n">label</span><span class="p">);</span>

<span class="w">        </span><span class="n">sliced_data</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">helper_eeglab_slice_chan</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">trial_idx</span><span class="p">,</span><span class="w"> </span><span class="n">has_freq</span><span class="p">);</span>
<span class="w">        </span><span class="n">s</span><span class="p">.(</span><span class="n">label</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">sliced_data</span><span class="p">;</span>
<span class="w">    </span><span class="k">end</span>

<span class="k">function</span><span class="w"> </span>result<span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">helper_eeglab_slice_chan</span><span class="p">(</span>data, trial_idx, has_freq<span class="p">)</span>
<span class="w">    </span><span class="nb">assert</span><span class="p">(</span><span class="nb">islogical</span><span class="p">(</span><span class="n">has_freq</span><span class="p">));</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">has_freq</span>
<span class="w">        </span><span class="n">trial_dim</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="n">trial_dim</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="c">% ensure enough trials</span>
<span class="w">    </span><span class="n">n_trials</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">size</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">trial_dim</span><span class="p">);</span>
<span class="w">    </span><span class="n">verify_trial_params</span><span class="p">(</span><span class="n">n_trials</span><span class="p">,</span><span class="w"> </span><span class="n">trial_idx</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">has_freq</span>
<span class="w">        </span><span class="n">result</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">data</span><span class="p">(:,</span><span class="w"> </span><span class="p">:,</span><span class="w"> </span><span class="n">trial_idx</span><span class="p">);</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="nb">assert</span><span class="p">(</span><span class="nb">numel</span><span class="p">(</span><span class="nb">size</span><span class="p">(</span><span class="n">data</span><span class="p">))</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="w">        </span><span class="n">result</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">data</span><span class="p">(</span><span class="n">trial_idx</span><span class="p">,</span><span class="w"> </span><span class="p">:);</span>
<span class="w">    </span><span class="k">end</span>

<span class="k">function</span><span class="w"> </span><span class="nf">[has_freq, freq_label, freq_values] = helper_eeglab_get_freq_info</span><span class="p">(</span>s<span class="p">)</span>
<span class="w">    </span><span class="n">samples_type</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">eeglab_get_samples_type</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
<span class="w">    </span><span class="n">has_freq</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">strcmp</span><span class="p">(</span><span class="n">samples_type</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;timefreq&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">nargout</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="k">return</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">has_freq</span>
<span class="w">        </span><span class="n">freq_label</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="s">&#39;freq&#39;</span><span class="p">};</span>
<span class="w">        </span><span class="n">freq_values</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="n">s</span><span class="p">.</span><span class="n">freqs</span><span class="p">};</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="n">freq_label</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">        </span><span class="n">freq_values</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">    </span><span class="k">end</span>

<span class="k">function</span><span class="w"> </span>ds<span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">convert_eeglab_struct</span><span class="p">(</span>s, opt<span class="p">)</span>
<span class="w">    </span><span class="n">samples_type</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">eeglab_get_samples_type</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
<span class="w">    </span><span class="p">[</span><span class="n">has_freq</span><span class="p">,</span><span class="w"> </span><span class="n">freq_label</span><span class="p">,</span><span class="w"> </span><span class="n">freq_values</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">helper_eeglab_get_freq_info</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
<span class="w">    </span><span class="n">freq_size</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">cellfun</span><span class="p">(@</span><span class="nb">numel</span><span class="p">,</span><span class="w"> </span><span class="n">freq_values</span><span class="p">);</span>

<span class="w">    </span><span class="p">[</span><span class="n">chan_prefix</span><span class="p">,</span><span class="w"> </span><span class="n">chan_suffix</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">eeglab_get_chan_pre_suffix</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">opt</span><span class="p">);</span>

<span class="w">    </span><span class="n">is_baseline</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="o">~</span><span class="nb">isempty</span><span class="p">(</span><span class="nb">regexp</span><span class="p">(</span><span class="n">chan_suffix</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;base$&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;once&#39;</span><span class="p">));</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">is_baseline</span>
<span class="w">        </span><span class="c">% because the baseline is computed over time</span>
<span class="w">        </span><span class="n">time_size</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">        </span><span class="n">time_values</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">        </span><span class="n">time_label</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="n">time_values</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="n">s</span><span class="p">.</span><span class="n">times</span><span class="p">};</span>
<span class="w">        </span><span class="n">time_label</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="s">&#39;time&#39;</span><span class="p">};</span>
<span class="w">        </span><span class="n">time_size</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">numel</span><span class="p">(</span><span class="n">time_values</span><span class="p">{</span><span class="mi">1</span><span class="p">});</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="c">% set channels</span>
<span class="w">    </span><span class="p">[</span><span class="n">eeglab_labels</span><span class="p">,</span><span class="w"> </span><span class="n">chan_values</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">eeglab_get_chan_labels</span><span class="p">(</span><span class="w"> </span><span class="k">...</span>
<span class="w">                                                          </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">chan_prefix</span><span class="p">,</span><span class="w"> </span><span class="n">chan_suffix</span><span class="p">);</span>
<span class="w">    </span><span class="n">n_chan</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">numel</span><span class="p">(</span><span class="n">chan_values</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">isfield</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;chanlabels&#39;</span><span class="p">)</span>
<span class="w">        </span><span class="nb">assert</span><span class="p">(</span><span class="nb">numel</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">chanlabels</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">n_chan</span><span class="p">);</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="n">data_cell</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">cell</span><span class="p">(</span><span class="n">n_chan</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">n_chan</span>
<span class="w">        </span><span class="c">% load data for each channel</span>
<span class="w">        </span><span class="n">key</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">eeglab_labels</span><span class="p">{</span><span class="n">k</span><span class="p">};</span>
<span class="w">        </span><span class="n">value</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">s</span><span class="p">.(</span><span class="n">key</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">has_freq</span>
<span class="w">            </span><span class="c">% it seems that for freq data, single trial data is the last</span>
<span class="w">            </span><span class="c">% dimension, whereas for erp data, single trial data is the first</span>
<span class="w">            </span><span class="c">% dimension. In any case we want to make single trial data the</span>
<span class="w">            </span><span class="c">% first dimension</span>
<span class="w">            </span><span class="n">has_trial_dim</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">size</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">~=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">has_trial_dim</span>
<span class="w">                </span><span class="n">value</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">shiftdim</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="w">            </span><span class="k">else</span>
<span class="w">                </span><span class="n">value</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">shiftdim</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="c">% insert singleton dimension</span>
<span class="w">            </span><span class="k">end</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="n">n_samples</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">size</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">size_chan_singleton</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="n">n_samples</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">freq_size</span><span class="p">],</span><span class="w"> </span><span class="n">time_size</span><span class="p">];</span>

<span class="w">        </span><span class="n">value_rs</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">reshape</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">size_chan_singleton</span><span class="p">);</span>
<span class="w">        </span><span class="n">data_cell</span><span class="p">{</span><span class="n">k</span><span class="p">}</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">value_rs</span><span class="p">;</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="n">meeg_parameters</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">parameters</span><span class="p">;</span>
<span class="w">    </span><span class="n">clear</span><span class="w"> </span><span class="s">s</span><span class="p">;</span>

<span class="w">    </span><span class="n">data</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">cat</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">data_cell</span><span class="p">{:});</span>
<span class="w">    </span><span class="n">clear</span><span class="w"> </span><span class="s">data_cell</span><span class="p">;</span>

<span class="w">    </span><span class="n">ds</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">cosmo_flatten</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="p">[{</span><span class="n">chan_prefix</span><span class="p">},</span><span class="w"> </span><span class="n">freq_label</span><span class="p">,</span><span class="w"> </span><span class="n">time_label</span><span class="p">],</span><span class="w"> </span><span class="k">...</span>
<span class="w">                       </span><span class="p">[{</span><span class="n">chan_values</span><span class="p">},</span><span class="w"> </span><span class="n">freq_values</span><span class="p">,</span><span class="w"> </span><span class="n">time_values</span><span class="p">]);</span>
<span class="w">    </span><span class="n">clear</span><span class="w"> </span><span class="s">data</span><span class="p">;</span>

<span class="w">    </span><span class="n">ds</span><span class="p">.</span><span class="n">sa</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">struct</span><span class="p">();</span>
<span class="w">    </span><span class="n">ds</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">meeg</span><span class="p">.</span><span class="n">samples_field</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;trial&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="n">ds</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">meeg</span><span class="p">.</span><span class="n">samples_type</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">samples_type</span><span class="p">;</span>
<span class="w">    </span><span class="n">ds</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">meeg</span><span class="p">.</span><span class="n">samples_label</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;rpt&#39;</span><span class="p">;</span>

<span class="w">    </span><span class="n">ds</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">meeg</span><span class="p">.</span><span class="n">parameters</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">meeg_parameters</span><span class="p">;</span>

<span class="w">    </span><span class="n">ds</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">posthoc_slice_dataset_if_necessary</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">opt</span><span class="p">);</span>

<span class="k">function</span><span class="w"> </span><span class="nf">[chan_prefix, chan_suffix] = eeglab_get_chan_pre_suffix</span><span class="p">(</span>s, opt<span class="p">)</span>
<span class="w">    </span><span class="nb">keys</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">fieldnames</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

<span class="w">    </span><span class="n">numeric_infix</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;1&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="n">pat</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="s">&#39;^(\D+)&#39;</span><span class="w"> </span><span class="n">numeric_infix</span><span class="w"> </span><span class="s">&#39;([\D_]*$)&#39;</span><span class="p">];</span>
<span class="w">    </span><span class="nb">matches</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">regexp</span><span class="p">(</span><span class="nb">keys</span><span class="p">,</span><span class="w"> </span><span class="n">pat</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;once&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;tokens&#39;</span><span class="p">);</span>

<span class="w">    </span><span class="n">match_idx</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">find</span><span class="p">(</span><span class="o">~</span><span class="nb">cellfun</span><span class="p">(@</span><span class="nb">isempty</span><span class="p">,</span><span class="w"> </span><span class="nb">matches</span><span class="p">));</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">numel</span><span class="p">(</span><span class="n">match_idx</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="n">unique_match</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">matches</span><span class="p">{</span><span class="n">match_idx</span><span class="p">};</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="n">unique_match</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">eeglab_select_idx_chan_pref_suffix</span><span class="p">(</span><span class="nb">matches</span><span class="p">,</span><span class="w"> </span><span class="n">opt</span><span class="p">);</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="n">chan_prefix</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">unique_match</span><span class="p">{</span><span class="mi">1</span><span class="p">};</span>
<span class="w">    </span><span class="n">chan_suffix</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">unique_match</span><span class="p">{</span><span class="mi">2</span><span class="p">};</span>

<span class="k">function</span><span class="w"> </span>match<span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">eeglab_select_idx_chan_pref_suffix</span><span class="p">(</span>all_matches, opt<span class="p">)</span>
<span class="w">    </span><span class="c">% typical use case is data with *_erspbase and _ersp data</span>
<span class="w">    </span><span class="n">key</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;data_field&#39;</span><span class="p">;</span>

<span class="w">    </span><span class="c">% &#39;erspboot&#39; are bootstrap estimates - no idea how to deal with these</span>
<span class="w">    </span><span class="c">% so for now they are not supported</span>
<span class="w">    </span><span class="n">not_supported_values</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="s">&#39;erspboot&#39;</span><span class="p">};</span>

<span class="w">    </span><span class="c">% get fieldnames to keep</span>
<span class="w">    </span><span class="n">get_match_name</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">@(</span><span class="n">x</span><span class="p">)</span><span class="n">x</span><span class="p">{</span><span class="mi">2</span><span class="p">}(</span><span class="mi">2</span><span class="p">:</span><span class="k">end</span><span class="p">);</span>
<span class="w">    </span><span class="n">match_func</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">@(</span><span class="n">x</span><span class="p">)</span><span class="o">~</span><span class="nb">isempty</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="k">...</span>
<span class="w">                    </span><span class="o">~</span><span class="n">cosmo_match</span><span class="p">({</span><span class="n">get_match_name</span><span class="p">(</span><span class="n">x</span><span class="p">)},</span><span class="w"> </span><span class="n">not_supported_values</span><span class="p">);</span>
<span class="w">    </span><span class="n">match_msk</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">cellfun</span><span class="p">(</span><span class="n">match_func</span><span class="p">,</span><span class="w"> </span><span class="n">all_matches</span><span class="p">);</span>
<span class="w">    </span><span class="nb">matches</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">all_matches</span><span class="p">(</span><span class="n">match_msk</span><span class="p">);</span>

<span class="w">    </span><span class="n">valid_values</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">cellfun</span><span class="p">(</span><span class="n">get_match_name</span><span class="p">,</span><span class="w"> </span><span class="nb">matches</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                           </span><span class="s">&#39;UniformOutput&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>

<span class="w">    </span><span class="n">suffix</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">sprintf</span><span class="p">(</span><span class="s">&#39;Valid options for the &#39;&#39;%s&#39;&#39; option are &#39;&#39;%s&#39;&#39;.&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                     </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">cosmo_strjoin</span><span class="p">(</span><span class="n">valid_values</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;&#39;&#39;, &#39;&#39;&#39;</span><span class="p">));</span>

<span class="w">    </span><span class="c">% try to be helpful</span>
<span class="w">    </span><span class="n">is_ersp</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">all</span><span class="p">(</span><span class="n">cosmo_match</span><span class="p">({</span><span class="s">&#39;erspbase&#39;</span><span class="p">;</span><span class="w"> </span><span class="s">&#39;ersp&#39;</span><span class="p">},</span><span class="w"> </span><span class="n">valid_values</span><span class="p">));</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">is_ersp</span>
<span class="w">        </span><span class="n">suffix</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">sprintf</span><span class="p">([</span><span class="s">&#39;%s\nThis data looks like an EEGLAB &#39;</span><span class="k">...</span>
<span class="w">                          </span><span class="s">&#39;ERSP data structure. Note &#39;</span><span class="k">...</span>
<span class="w">                          </span><span class="s">&#39;that the &#39;&#39;ersp&#39;&#39; option returns a &#39;</span><span class="k">...</span>
<span class="w">                          </span><span class="s">&#39;raw dataset (presumably without baseline, &#39;</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                          </span><span class="s">&#39;correction), whereas &#39;&#39;erspbase&#39;&#39; returns the &#39;</span><span class="k">...</span>
<span class="w">                          </span><span class="s">&#39; baseline &#39;</span><span class="k">...</span>
<span class="w">                          </span><span class="s">&#39;values themselves (that can be used for baseline &#39;</span><span class="k">...</span>
<span class="w">                          </span><span class="s">&#39;correction). It is currently not possible to &#39;</span><span class="k">...</span>
<span class="w">                          </span><span class="s">&#39;return baseline corrected data with this &#39;</span><span class="k">...</span>
<span class="w">                          </span><span class="s">&#39;function.&#39;</span><span class="p">],</span><span class="w"> </span><span class="n">suffix</span><span class="p">);</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">~</span><span class="nb">isfield</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">)</span>
<span class="w">        </span><span class="nb">error</span><span class="p">(</span><span class="s">&#39;The &#39;&#39;%s&#39;&#39; option is required. %s&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">suffix</span><span class="p">);</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="n">value</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">opt</span><span class="p">.(</span><span class="n">key</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">~</span><span class="nb">ischar</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<span class="w">        </span><span class="nb">error</span><span class="p">(</span><span class="s">&#39;The &#39;&#39;%s&#39;&#39; option must be a string. %s&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">suffix</span><span class="p">);</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="n">idx</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">find</span><span class="p">(</span><span class="n">cosmo_match</span><span class="p">(</span><span class="n">valid_values</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">));</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">isempty</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
<span class="w">        </span><span class="nb">error</span><span class="p">(</span><span class="n">suffix</span><span class="p">);</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="n">match</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">matches</span><span class="p">{</span><span class="n">idx</span><span class="p">};</span>

<span class="k">function</span><span class="err"> [</span><span class="nf">eeglab_labels</span><span class="p">,</span><span class="w"> </span><span class="n">cosmo_labels</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">eeglab_get_chan_labels</span><span class="p">(</span><span class="w"> </span><span class="k">...</span>
<span class="w">                                                                </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">chan_prefix</span><span class="p">,</span><span class="w"> </span><span class="n">chan_suffix</span><span class="p">)</span>

<span class="w">    </span><span class="n">make_eeglab_label</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">@(</span><span class="n">idx</span><span class="p">)</span><span class="nb">sprintf</span><span class="p">(</span><span class="s">&#39;%s%d%s&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">chan_prefix</span><span class="p">,</span><span class="w"> </span><span class="n">idx</span><span class="p">,</span><span class="w"> </span><span class="n">chan_suffix</span><span class="p">);</span>
<span class="w">    </span><span class="c">% see how many labels there are</span>
<span class="w">    </span><span class="nb">count</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="nb">true</span>
<span class="w">        </span><span class="n">label</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">make_eeglab_label</span><span class="p">(</span><span class="nb">count</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">~</span><span class="nb">isfield</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">label</span><span class="p">)</span>
<span class="w">            </span><span class="k">break</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">        </span><span class="nb">count</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">count</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="n">idxs</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="nb">count</span><span class="p">;</span>

<span class="w">    </span><span class="n">eeglab_labels</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">arrayfun</span><span class="p">(</span><span class="n">make_eeglab_label</span><span class="p">,</span><span class="w"> </span><span class="n">idxs</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;UniformOutput&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">strcmp</span><span class="p">(</span><span class="n">chan_prefix</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;comp&#39;</span><span class="p">)</span>
<span class="w">        </span><span class="nb">assert</span><span class="p">(</span><span class="o">~</span><span class="nb">isfield</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;chanlabels&#39;</span><span class="p">));</span>
<span class="w">        </span><span class="n">make_comp_label</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">@(</span><span class="n">idx</span><span class="p">)</span><span class="nb">sprintf</span><span class="p">(</span><span class="s">&#39;comp%d&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">idx</span><span class="p">);</span>
<span class="w">        </span><span class="n">cosmo_labels</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">arrayfun</span><span class="p">(</span><span class="n">make_comp_label</span><span class="p">,</span><span class="w"> </span><span class="n">idxs</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;UniformOutput&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="n">cosmo_labels</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">chanlabels</span><span class="p">;</span>
<span class="w">    </span><span class="k">end</span>

<span class="k">function</span><span class="w"> </span>samples_type<span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">eeglab_get_samples_type</span><span class="p">(</span>s<span class="p">)</span>
<span class="w">    </span><span class="n">mapping</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="s">&#39;erp&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;timelock&#39;</span><span class="p">;</span><span class="w"> </span><span class="k">...</span>
<span class="w">               </span><span class="s">&#39;timef&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;timefreq&#39;</span><span class="p">;</span><span class="w"> </span><span class="k">...</span>
<span class="w">               </span><span class="s">&#39;itc&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;timefreq&#39;</span><span class="p">;</span><span class="w"> </span><span class="k">...</span>
<span class="w">               </span><span class="s">&#39;ersp&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;timefreq&#39;</span><span class="p">;</span><span class="w"> </span><span class="k">...</span>
<span class="w">               </span><span class="s">&#39;erspbase&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;baseline&#39;</span><span class="p">};</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="nb">size</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="n">row</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">mapping</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="p">:);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nb">strcmp</span><span class="p">(</span><span class="nb">lower</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">datatype</span><span class="p">),</span><span class="w"> </span><span class="n">row</span><span class="p">{</span><span class="mi">1</span><span class="p">})</span>
<span class="w">            </span><span class="n">samples_type</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">row</span><span class="p">{</span><span class="mi">2</span><span class="p">};</span>
<span class="w">            </span><span class="k">return</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="nb">error</span><span class="p">(</span><span class="s">&#39;unsupported datatype mapping &#39;&#39;%s&#39;&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">datatype</span><span class="p">);</span>

<span class="w">    </span><span class="c">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="w">    </span><span class="c">% eeglab txt helper function</span>
<span class="w">    </span><span class="c">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>

<span class="k">function</span><span class="w"> </span>ds<span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">read_eeglab_txt</span><span class="p">(</span>fn, opt<span class="p">)</span>
<span class="w">    </span><span class="c">% reads eeglab time series data. returns data in fieldtrip-like format</span>
<span class="w">    </span><span class="n">fid</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">fopen</span><span class="p">(</span><span class="n">fn</span><span class="p">);</span>

<span class="w">    </span><span class="n">header_line</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">fgetl</span><span class="p">(</span><span class="n">fid</span><span class="p">);</span><span class="w"> </span><span class="c">% read header</span>
<span class="w">    </span><span class="n">chan_labels</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">cosmo_strsplit</span><span class="p">(</span><span class="n">header_line</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;\t&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="n">chan_labels</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">chan_labels</span><span class="p">(</span><span class="mi">2</span><span class="p">:(</span><span class="k">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span><span class="w"> </span><span class="c">% omit first &amp; last bogus element</span>

<span class="w">    </span><span class="n">nchan</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">numel</span><span class="p">(</span><span class="n">chan_labels</span><span class="p">);</span>
<span class="w">    </span><span class="n">data_pat</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">cosmo_strjoin</span><span class="p">(</span><span class="nb">repmat</span><span class="p">({</span><span class="s">&#39;%n&#39;</span><span class="p">},</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nchan</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="s">&#39; &#39;</span><span class="p">);</span>

<span class="w">    </span><span class="c">% read data from file</span>
<span class="w">    </span><span class="n">cell_data</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">textscan</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span><span class="w"> </span><span class="n">data_pat</span><span class="p">);</span>

<span class="w">    </span><span class="c">% check all data was read</span>
<span class="w">    </span><span class="n">neg_one</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">fgetl</span><span class="p">(</span><span class="n">fid</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">neg_one</span><span class="w"> </span><span class="o">~=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span>
<span class="w">        </span><span class="nb">error</span><span class="p">(</span><span class="s">&#39;Could not read all data from %s&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">fn</span><span class="p">);</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="c">%%%%%%%%%%%%%%%</span>
<span class="w">    </span><span class="c">% data consistency checks</span>

<span class="w">    </span><span class="c">% timepoints are in the first column, data in other columns</span>
<span class="w">    </span><span class="n">timepoints</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">cell_data</span><span class="p">{</span><span class="mi">1</span><span class="p">};</span>
<span class="w">    </span><span class="n">nrows</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">numel</span><span class="p">(</span><span class="n">timepoints</span><span class="p">);</span>

<span class="w">    </span><span class="p">[</span><span class="n">unused</span><span class="p">,</span><span class="w"> </span><span class="n">t_trial</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">cosmo_index_unique</span><span class="p">(</span><span class="n">timepoints</span><span class="p">);</span>
<span class="w">    </span><span class="n">ntime</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">numel</span><span class="p">(</span><span class="n">t_trial</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">mod</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="n">ntime</span><span class="p">)</span><span class="w"> </span><span class="o">~=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="k">...</span>
<span class="w">                </span><span class="o">~</span><span class="nb">all</span><span class="p">(</span><span class="nb">all</span><span class="p">(</span><span class="nb">bsxfun</span><span class="p">(@</span><span class="nb">eq</span><span class="p">,</span><span class="w"> </span><span class="nb">reshape</span><span class="p">(</span><span class="n">timepoints</span><span class="p">,</span><span class="w"> </span><span class="n">ntime</span><span class="p">,</span><span class="w"> </span><span class="p">[]),</span><span class="w"> </span><span class="k">...</span>
<span class="w">                                </span><span class="n">t_trial</span><span class="p">)))</span>
<span class="w">        </span><span class="nb">error</span><span class="p">(</span><span class="s">&#39;Data not contiguous or unexpected order of time points&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="c">% number of trials</span>
<span class="w">    </span><span class="n">ntrial</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">nrows</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">ntime</span><span class="p">;</span>

<span class="w">    </span><span class="c">%%%%%%%%%%%%%%%</span>
<span class="w">    </span><span class="c">% put the data in 3D array</span>
<span class="w">    </span><span class="n">data</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="n">ntrial</span><span class="p">,</span><span class="w"> </span><span class="n">nchan</span><span class="p">,</span><span class="w"> </span><span class="n">ntime</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">chan</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="n">nchan</span>
<span class="w">        </span><span class="n">chan_data</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">cell_data</span><span class="p">{</span><span class="n">chan</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">};</span><span class="w"> </span><span class="c">% skip first column as it has timepoints</span>
<span class="w">        </span><span class="n">data</span><span class="p">(:,</span><span class="w"> </span><span class="n">chan</span><span class="p">,</span><span class="w"> </span><span class="p">:)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">reshape</span><span class="p">(</span><span class="n">chan_data</span><span class="p">,</span><span class="w"> </span><span class="n">ntime</span><span class="p">,</span><span class="w"> </span><span class="n">ntrial</span><span class="p">)</span><span class="o">&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="c">%%%%%%%%%%%%%%%</span>
<span class="w">    </span><span class="c">% flatten and make it a dataset</span>
<span class="w">    </span><span class="c">% (convert milliseconds to seconds along the way)</span>
<span class="w">    </span><span class="n">dim_labels</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="s">&#39;chan&#39;</span><span class="p">;</span><span class="w"> </span><span class="s">&#39;time&#39;</span><span class="p">};</span>
<span class="w">    </span><span class="n">dim_values</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="n">chan_labels</span><span class="p">(:)</span><span class="o">&#39;</span><span class="p">;</span><span class="w"> </span><span class="mf">.001</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">t_trial</span><span class="p">(:)</span><span class="o">&#39;</span><span class="p">};</span>

<span class="w">    </span><span class="c">% make a dataset</span>
<span class="w">    </span><span class="n">ds</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">cosmo_flatten</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">dim_labels</span><span class="p">,</span><span class="w"> </span><span class="n">dim_values</span><span class="p">);</span>

<span class="w">    </span><span class="c">% set datatype to timelock-ish in fieldtrip-compatible way</span>
<span class="w">    </span><span class="n">ds</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">meeg</span><span class="p">.</span><span class="n">samples_field</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;trial&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="n">ds</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">meeg</span><span class="p">.</span><span class="n">samples_type</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;timelock&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="n">ds</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">meeg</span><span class="p">.</span><span class="n">samples_label</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;rpt&#39;</span><span class="p">;</span>

<span class="w">    </span><span class="c">% set sample info</span>
<span class="w">    </span><span class="n">ds</span><span class="p">.</span><span class="n">sa</span><span class="p">.(</span><span class="n">ds</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">meeg</span><span class="p">.</span><span class="n">samples_label</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ntrial</span><span class="p">)</span><span class="o">&#39;</span><span class="p">;</span>

<span class="w">    </span><span class="n">ds</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">posthoc_slice_dataset_if_necessary</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">opt</span><span class="p">);</span>
</pre></div>
</div>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/cosmomvpa_logo.png" alt="Logo of CoSMo Multivariate Pattern Analysis toolbox"/>
            </a></p>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="cosmo_meeg_chantype.html"
                          title="previous chapter">cosmo meeg chantype</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="cosmo_meeg_find_layout.html"
                          title="next chapter">cosmo meeg find layout</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/matlab/cosmo_meeg_dataset.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="cosmo_meeg_find_layout.html" title="cosmo meeg find layout"
             >next</a> |</li>
        <li class="right" >
          <a href="cosmo_meeg_chantype.html" title="cosmo meeg chantype"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">CoSMoMVPA</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../documentation.html" >Documentation</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../nmsm2019.html" >NMSM 2019, Noesselt’s lab 3rd Modelling Symposium, University of Magdeburg</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="../matindex.html" >CoSMoMVPA functions</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">cosmo meeg dataset</a></li> 
      </ul>
    </div>
      <div class="footer">
       <span class="creativecommons">
          <a href="http://opensource.org/licenses/MIT" >
          <img src="../_static/mit-license_logo.png"
               border="0" alt="Creative Commons License"/>
         </a> 
         
        <a href="copyright.html">Copyright 2013-2021 Nikolaas N. Oosterhof, Andrew C. Connolly, CoSMoMVPA contributors</a>.
        CoSMoMVPA is licensed under an <a href="http://opensource.org/licenses/MIT">Expat (MIT) License</a>.
       </span>
      </div>
  </body>
</html>